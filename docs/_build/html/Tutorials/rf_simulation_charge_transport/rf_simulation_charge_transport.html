

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RF simulation with charge transport data &mdash; Imodulator 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=7026087e"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="DC electro-optical modulation" href="../dc_electro_optical/dc_electro_optical.html" />
    <link rel="prev" title="RF simulation" href="../rf_simulation/rf_simulation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Imodulator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PhotonicPolygon.html">Photonic Polygons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.name"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.electro_optic_module"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.electro_optic_module</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.electro_optic_module_kwargs"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.electro_optic_module_kwargs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.d_buffer_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.charge_transport_simulator_kwargs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon"><code class="docutils literal notranslate"><span class="pre">MetalPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.name"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.d_buffer_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.charge_transport_simulator_kwargs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.name"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.electro_optic_module"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.electro_optic_module</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.charge_transport_simulator_kwargs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.d_buffer_current</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../PhotonicDevice.html">Photonic Device</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice.__init__"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice.plot_polygons"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice.plot_polygons()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicDevice.html#references">References</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Charge-transport simulators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ChargeSimulators/ChargeSimulatorNN.html">ChargeSimulatorNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ChargeSimulators/ChargeSimulatorSolcore.html">ChargeSimulatorSolcore</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RF mode solvers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../RFSimulators/RFSimulatorFEMWELL.html">RFSimulatorFEMWELL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optical mode solvers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalSimulators/OpticalSimulatorFEMWELL.html">OpticalSimulatorFEMWELL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalSimulators/OpticalSimulatorMODE.html">OpticalSimulatorMODE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Electro Optical models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ElectroOpticalModels/InGaAsPElectroOpticalModel.html">InGaAsPElectroOpticalModel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Electro-optic simulators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ElectroOpticalSimulators/ElectroOpticalSimulator.html">ElectroOpticalSimulator</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../building_photonic_device/building_photonic_device.html">Building a PhotonicDevice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optical_simulation_femwell/optical_simulation_femwell.html">Optical simulation with FEMWELL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../optical_simulation_femwell/optical_simulation_femwell.html#Mesh-refinement">Mesh refinement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../poisson_drift_diffusion_solcore/poisson_drift_diffusion_solcore.html">Solving the poisson-drift-diffusion equation with Solcore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rf_simulation/rf_simulation.html">RF simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Mesh-refinement">Mesh refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Using-a-symmetry-plane">Using a symmetry plane</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Frequency-sweep">Frequency sweep</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">RF simulation with charge transport data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Solving-the-poisson-drift-diffusion-equation">Solving the poisson-drift-diffusion equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Solving-the-RF-mode">Solving the RF mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Frequency-sweep">Frequency sweep</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Voltage-sweep">Voltage sweep</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html">DC electro-optical modulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Find-the-optical-mode">Find the optical mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Solve-the-charge-transport-equations">Solve the charge transport equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Calculate-the-electro-optic-response">Calculate the electro optic response</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Correcting-PDD-data">Correcting PDD data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../polarization_converter/polarization_converter.html">Active polarization controller</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../polarization_converter/polarization_converter.html#Phase-matching-condition">Phase matching condition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarization_converter/polarization_converter.html#Solving-the-PDD">Solving the PDD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarization_converter/polarization_converter.html#Calculate-the-electro-optic-response">Calculate the electro-optic response</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Imodulator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">RF simulation with charge transport data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Tutorials/rf_simulation_charge_transport/rf_simulation_charge_transport.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="RF-simulation-with-charge-transport-data">
<h1>RF simulation with charge transport data<a class="headerlink" href="#RF-simulation-with-charge-transport-data" title="Link to this heading">ÔÉÅ</a></h1>
<p>In this tutorial we will be exploring RF simulations while including the results obtained from the poisson-drift-diffusion solver.</p>
<div style="text-align: center;"><p><img alt="Alt text" src="../../_images/main3.png" /></p>
</div><p>To do so, we will use the <code class="docutils literal notranslate"><span class="pre">InP_EOPM</span></code> class created in the <code class="docutils literal notranslate"><span class="pre">Building</span> <span class="pre">a</span> <span class="pre">PhotonicdDevice</span></code> tutorial. We shall start by redefining our class:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">imodulator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openbandparams</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">obp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ElectroOpticalModel</span><span class="w"> </span><span class="kn">import</span> <span class="n">InGaAsPElectroOpticalModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ChargeSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChargeSimulatorSolcore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.RFSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">RFSimulatorFEMWELL</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="k">def</span><span class="w"> </span><span class="nf">tand_fitted_bcb</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitted to results from https://link.springer.com/article/10.1007/s10762-009-9552-0</span>

<span class="sd">    x must be in GHz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span>  <span class="mf">0.0093839</span> <span class="o">-</span> <span class="mf">0.01790336</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.04773444</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="o">-</span><span class="mf">4.64170761</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InP_EOPM</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="mf">1.60e-19</span> <span class="c1"># electron charge in C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e0</span> <span class="o">=</span> <span class="mf">8.85e-12</span> <span class="c1"># vacuum permittivity in F/m</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Width of signal metal in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Separation between signal and ground metals in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Height of metals in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">=</span> <span class="mf">0.2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_top</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="k">for</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_meshes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># optical mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># RF mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># eo mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#We will now set the RF properties of the metals and the BCB</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">#GHz. This will be the simulation frequency</span>

        <span class="n">eps_rf_metal</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">6e7</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">eps_rf_metal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">freq</span><span class="p">,</span> <span class="n">eps_rf_metal</span><span class="p">])</span>

        <span class="n">bcb_eps_real</span> <span class="o">=</span> <span class="mf">2.65</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">bcb_eps_imag</span> <span class="o">=</span> <span class="n">bcb_eps_real</span> <span class="o">*</span> <span class="n">tand_fitted_bcb</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

        <span class="n">bcb_eps</span> <span class="o">=</span> <span class="n">bcb_eps_real</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">bcb_eps_imag</span>
        <span class="n">bcb_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">freq</span><span class="p">,</span> <span class="n">bcb_eps</span><span class="p">])</span>

        <span class="c1">#Now we create the PhotoPolygons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substrate</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mf">11.7</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;substrate&#39;</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mi">3</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_top</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;background&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mf">3.9</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">3.9</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.44</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;box&#39;</span>
        <span class="p">)</span>

        <span class="n">n_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">n_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">n_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">n_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e18</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">wg1_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mf">0.53</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wg1</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">wg1_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">wg1_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wg1&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mf">0.53</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg1_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e16</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">wg2_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wg2</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">wg2_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">wg2_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wg2&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e16</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p1_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">p1_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">p1_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p1&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Na&#39;</span><span class="p">:</span> <span class="mf">1e17</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p2_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">p2_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">p2_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p2&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">p2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Na&#39;</span><span class="p">:</span> <span class="mf">1e19</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_far_left&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_far_right&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_left&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_right&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_metal</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;sig_metal&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">d_buffer_current</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n_metal_left&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n_metal_right&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">photo_polygons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_metal</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wg2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wg1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">substrate</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="p">]</span>

        <span class="c1">#Just in case there are empty polygons</span>
        <span class="n">idxs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">photo_polygons</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">poly</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="n">idxs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs_to_remove</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">photo_polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">PhotonicDevice</span><span class="p">(</span>
            <span class="n">photo_polygons</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Successfully imported lumapi
WARNING: The RCWA solver will not be available because an S4 installation has not been found.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\solcore\registries.py:73: UserWarning: Optics solver &#39;RCWA&#39; will not be available. An installation of S4 has not been found.
  warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Successfully imported nextnanopy
Successfully configured nextnano++ settings
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\nextnanopy\defaults.py:202: UserWarning: Unsupported products in config file: [&#39;nextnano.NEGF++&#39;] will be ignored. To not see this message, please remove unsupported products from the config file: C:\Users\20230622\.nextnanopy-configNote: nextnano.NEGF++ was renamed to nextnano.NEGF, nextnano.NEGF was renamed to nextnano.NEGF_classic. Please check the documentation for more details.
  warnings.warn(
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eopm</span> <span class="o">=</span> <span class="n">InP_EOPM</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_make_meshes</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_create_polygons</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_initialize_device</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">(</span>
        <span class="n">color_polygon</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">color_line</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="n">color_junctions</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="n">fill_polygons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (um)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (um)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_2_0.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_2_0.png" />
</div>
</div>
<section id="Solving-the-poisson-drift-diffusion-equation">
<h2>Solving the poisson-drift-diffusion equation<a class="headerlink" href="#Solving-the-poisson-drift-diffusion-equation" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">+</span><span class="mf">0.01</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_n</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg2</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">]])</span> <span class="c1">#simulation line</span>

<span class="n">charge</span><span class="o">=</span><span class="n">ChargeSimulatorSolcore</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_line</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
    <span class="n">bias_start_stop_step</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">plot_with_simulation_line</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Charge transport will take place with:
p2
p1
wg2
wg1
n
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-1.0, 3.0)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_4_2.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_4_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_5_0.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_5_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">solve_PDD</span><span class="p">(</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">smooth_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">charge</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span>
    <span class="n">V_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Material &#34;n&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Solving IV of the junctions...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\solcore\sesame_drift_diffusion\solve_pdd.py:193: UserWarning: All voltages are positive, but junction has been identified as n-p, so the  open-circuit voltage (Voc) of the junction will be negative.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Solving IV of the tunnel junctions...
Solving IV of the total solar cell...
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_6_3.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_6_3.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">transfer_results_to_device</span><span class="p">(</span><span class="n">xmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Solving-the-RF-mode">
<h2>Solving the RF mode<a class="headerlink" href="#Solving-the-RF-mode" title="Link to this heading">ÔÉÅ</a></h2>
<p>Here we will move directly with a symmetry plane, as we will be characterizing a CPW line</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_sim</span> <span class="o">=</span> <span class="n">RFSimulatorFEMWELL</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">simulation_window</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mi">350</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">350</span><span class="p">))</span>
<span class="n">rf_sim</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">(</span>
    <span class="n">gmsh_algorithm</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of elements&#39;</span><span class="p">,</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nelements</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>

<span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of elements 638
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-5.0, 5.0)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_9_2.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_9_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_9_3.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_9_3.png" />
</div>
</div>
<p>We can now inspect the permitivity of our structure, but as opposed to what was done in the <code class="docutils literal notranslate"><span class="pre">RF</span> <span class="pre">Simulation</span></code> tutorial, we now have charge data with some voltage dependency. Therefore, we can use the keyword arguments <code class="docutils literal notranslate"><span class="pre">use_charge_transport_data</span></code> and <code class="docutils literal notranslate"><span class="pre">voltage_idx</span></code>. When using the charge transport data, we simply use them to calculate the conductivity assuming the Drude model:</p>
<div class="math notranslate nohighlight">
\[\sigma (x,y,V) = e\left(\mu_n (x,y) N(x,y,V) + \mu_p (x,y) P(x,y,V)\right)\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">plot_eps_rf</span><span class="p">(</span>
    <span class="n">frequency</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#GHz</span>
    <span class="n">log_scale_re</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">log_scale_im</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">voltage_idx</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">plot_eps_rf</span><span class="p">(</span>
    <span class="n">frequency</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#GHz</span>
    <span class="n">log_scale_re</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">log_scale_im</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">voltage_idx</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_11_0.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_11_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_11_1.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_11_1.png" />
</div>
</div>
<p>For the moment the mesh is quite coarse and we cannot see much. Let us calculate some modes and then move to some mesh refinement</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_sim</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
            <span class="n">metallic_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">],</span>
            <span class="n">n_guess</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">num_modes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">return_modes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">voltage_idx</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effective index - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loss - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dB/cm&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#------------------------------------------#&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">mode_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">)):</span>
    <span class="n">rf_sim</span><span class="o">.</span><span class="n">plot_mode</span><span class="p">(</span>
        <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">mode_idx</span><span class="p">],</span>
        <span class="n">Nx</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">Ny</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">xmax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ymin</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">ymax</span><span class="o">=</span><span class="mi">30</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Effective index - mode 0: 0.3749
loss - mode 0: -2697.08 dB/cm
#------------------------------------------#
Effective index - mode 1: 2.1328
loss - mode 1: 0.67 dB/cm
#------------------------------------------#
Effective index - mode 2: 4.1897
loss - mode 2: 4.94 dB/cm
#------------------------------------------#
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\skfem\assembly\form\linear_form.py:44: ComplexWarning: Casting complex values to real discards the imaginary part
  data[ixs] = self._kernel(vbasis.basis[i], w, dx)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_13_2.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_13_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_13_3.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_13_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_13_4.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_13_4.png" />
</div>
</div>
<p>With this we see we are interested in mode number 1. Let us hope there is no mode jump and we can stay with mode index 2 for the full refinement.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">neff</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nelements</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">z0</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">rf_sim</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--- Refinement iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> ---&#39;</span><span class="p">)</span>

    <span class="n">rf_sim</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
            <span class="n">metallic_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">],</span>
            <span class="n">n_guess</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">num_modes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">return_modes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">voltage_idx</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>


    <span class="n">loss_tmp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
        <span class="n">loss_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

    <span class="n">idx_mode</span> <span class="o">=</span> <span class="mi">2</span>


    <span class="c1">######### Calculate characteristic impedance #########</span>
    <span class="n">p0</span><span class="p">,</span> <span class="n">i0_all</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">get_currents</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">])</span>

    <span class="n">I0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i0_all</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">]</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p0</span>

    <span class="n">Z0</span> <span class="o">=</span> <span class="n">p0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">I0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">z0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Z0</span><span class="p">)</span>
    <span class="c1">######################################################</span>

    <span class="n">nelements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nelements</span><span class="p">)</span>
    <span class="n">neff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

    <span class="n">rf_sim</span><span class="o">.</span><span class="n">refine_mesh</span><span class="p">(</span><span class="n">mode_for_refinement</span><span class="o">=</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Nelements: </span><span class="si">{</span><span class="n">rf_sim</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nelements</span><span class="si">}</span><span class="s1"> | neff: </span><span class="si">{</span><span class="n">neff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> | loss: </span><span class="si">{</span><span class="n">loss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dB/cm | Z0: </span><span class="si">{</span><span class="n">z0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> Ohm&#39;</span><span class="p">)</span>


<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Refinement iteration 0 ---
Nelements: 940 | neff: 4.348577 | loss: 8.80 dB/cm | Z0: 76.85-4.60j Ohm
--- Refinement iteration 1 ---
Nelements: 1033 | neff: 4.226509 | loss: 8.48 dB/cm | Z0: 78.50-4.89j Ohm
--- Refinement iteration 2 ---
Nelements: 1103 | neff: 3.686867 | loss: 8.66 dB/cm | Z0: 91.91-4.51j Ohm
--- Refinement iteration 3 ---
Nelements: 1131 | neff: 3.603673 | loss: 8.48 dB/cm | Z0: 93.40-4.72j Ohm
--- Refinement iteration 4 ---
Nelements: 1247 | neff: 3.544029 | loss: 8.27 dB/cm | Z0: 92.92-4.84j Ohm
--- Refinement iteration 5 ---
Nelements: 1402 | neff: 3.449524 | loss: 7.96 dB/cm | Z0: 87.81-4.76j Ohm
--- Refinement iteration 6 ---
Nelements: 1467 | neff: 3.436453 | loss: 7.71 dB/cm | Z0: 76.53-3.99j Ohm
--- Refinement iteration 7 ---
Nelements: 1671 | neff: 3.437134 | loss: 7.73 dB/cm | Z0: 67.80-3.60j Ohm
--- Refinement iteration 8 ---
Nelements: 1709 | neff: 3.398102 | loss: 7.56 dB/cm | Z0: 63.12-3.27j Ohm
--- Refinement iteration 9 ---
Nelements: 2150 | neff: 3.388048 | loss: 7.54 dB/cm | Z0: 63.33-3.27j Ohm
--- Refinement iteration 10 ---
Nelements: 2479 | neff: 3.391891 | loss: 8.04 dB/cm | Z0: 63.30-2.23j Ohm
--- Refinement iteration 11 ---
Nelements: 2888 | neff: 3.375809 | loss: 7.84 dB/cm | Z0: 51.94-1.83j Ohm
--- Refinement iteration 12 ---
Nelements: 3320 | neff: 3.365038 | loss: 7.75 dB/cm | Z0: 48.42-1.75j Ohm
--- Refinement iteration 13 ---
Nelements: 4020 | neff: 3.369180 | loss: 7.27 dB/cm | Z0: 47.65-1.50j Ohm
--- Refinement iteration 14 ---
Nelements: 4444 | neff: 3.375109 | loss: 7.21 dB/cm | Z0: 45.76-1.50j Ohm
--- Refinement iteration 15 ---
Nelements: 4692 | neff: 3.406722 | loss: 6.62 dB/cm | Z0: 46.71-1.17j Ohm
--- Refinement iteration 16 ---
Nelements: 6042 | neff: 3.415883 | loss: 6.56 dB/cm | Z0: 46.67-1.15j Ohm
--- Refinement iteration 17 ---
Nelements: 6196 | neff: 3.417371 | loss: 6.50 dB/cm | Z0: 45.70-1.03j Ohm
--- Refinement iteration 18 ---
Nelements: 7489 | neff: 3.420925 | loss: 6.48 dB/cm | Z0: 45.74-1.02j Ohm
--- Refinement iteration 19 ---
Nelements: 8172 | neff: 3.428938 | loss: 6.52 dB/cm | Z0: 45.13-0.94j Ohm
--- Refinement iteration 20 ---
Nelements: 8194 | neff: 3.428366 | loss: 6.48 dB/cm | Z0: 44.95-0.92j Ohm
--- Refinement iteration 21 ---
Nelements: 9394 | neff: 3.428348 | loss: 6.48 dB/cm | Z0: 44.95-0.92j Ohm
--- Refinement iteration 22 ---
Nelements: 9422 | neff: 3.428203 | loss: 6.48 dB/cm | Z0: 44.88-0.91j Ohm
--- Refinement iteration 23 ---
Nelements: 11456 | neff: 3.428186 | loss: 6.48 dB/cm | Z0: 44.88-0.91j Ohm
--- Refinement iteration 24 ---
Nelements: 11870 | neff: 3.442275 | loss: 6.44 dB/cm | Z0: 44.91-0.85j Ohm
--- Refinement iteration 25 ---
Nelements: 15276 | neff: 3.448830 | loss: 6.47 dB/cm | Z0: 44.81-0.83j Ohm
--- Refinement iteration 26 ---
Nelements: 15378 | neff: 3.466352 | loss: 6.57 dB/cm | Z0: 44.12-0.57j Ohm
--- Refinement iteration 27 ---
Nelements: 16835 | neff: 3.467419 | loss: 6.57 dB/cm | Z0: 44.15-0.57j Ohm
--- Refinement iteration 28 ---
Nelements: 18231 | neff: 3.479947 | loss: 6.45 dB/cm | Z0: 44.25-0.47j Ohm
--- Refinement iteration 29 ---
Nelements: 18695 | neff: 3.481614 | loss: 6.46 dB/cm | Z0: 44.17-0.46j Ohm
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">n_iterations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nelements</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">neff</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">nelements</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z0</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Refinement iteration&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Refinement iteration&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Refinement iteration&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Refinement iteration&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effective index (Re)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Propagation loss (dB/m)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of elements&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Characteristic Impedance (Ohm)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_16_0.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_16_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">boundaries</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-10.0, 10.0)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_17_1.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_17_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">plot_eps_rf</span><span class="p">(</span>
    <span class="n">frequency</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#GHz</span>
    <span class="n">log_scale_re</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">log_scale_im</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">voltage_idx</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">plot_eps_rf</span><span class="p">(</span>
    <span class="n">frequency</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#GHz</span>
    <span class="n">log_scale_re</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">log_scale_im</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">voltage_idx</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\20230622\OneDrive - TU Eindhoven\PhD\Python packages\photonmod\src\imodulator\RFSimulator.py:506: RuntimeWarning: divide by zero encountered in log10
  data_to_plot_im = np.log10(-data_to_plot_im)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\skfem\assembly\basis\cell_basis.py:152: RuntimeWarning: invalid value encountered in multiply
  w += y[self.element_dofs[j]][:, None] * basis[0]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_18_1.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_18_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_18_2.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_18_2.png" />
</div>
</div>
<p>As you can see we now see far more details than before, where even the depletion region is now well defined.</p>
</section>
<section id="Frequency-sweep">
<h2>Frequency sweep<a class="headerlink" href="#Frequency-sweep" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">freq_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>

<span class="n">n_modes</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">neff_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">freq_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">loss_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">freq_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">Z0_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">freq_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">s11_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">freq_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">s12_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">freq_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freq_values</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--- Frequency: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> GHz ---&#39;</span><span class="p">)</span>
    <span class="n">rf_sim</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">f</span><span class="p">,</span>
        <span class="n">metallic_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">],</span>
        <span class="n">voltage_idx</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">n_guess</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">num_modes</span> <span class="o">=</span> <span class="n">n_modes</span><span class="p">,</span>
        <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">return_modes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1">#Let us select the mode that has a positive value for loss</span>
    <span class="c1">#The current geometry will only allow for one physical mode. We are purposely calculating two modes, but one of them will be some radiative mode with negative loss (gain).</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_modes</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span> <span class="c1">#dB/cm</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">i0_all</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">get_currents</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">p0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p0</span>
        <span class="n">I0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i0_all</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">]</span>

        <span class="n">Z0</span> <span class="o">=</span> <span class="n">p0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">I0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">s11</span><span class="p">,</span> <span class="n">s12</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">get_S</span><span class="p">(</span>
            <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">Z0</span> <span class="p">,</span>
            <span class="n">ZL</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">ZS</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">L</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="c1">#um</span>
        <span class="p">)</span>


        <span class="n">neff_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span>
        <span class="n">loss_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span> <span class="c1">#dB/cm</span>
        <span class="n">Z0_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z0</span>
        <span class="n">s11_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s11</span>
        <span class="n">s12_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s12</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Frequency: 1.0 GHz ---
--- Frequency: 4.413793103448276 GHz ---
--- Frequency: 7.827586206896552 GHz ---
--- Frequency: 11.241379310344827 GHz ---
--- Frequency: 14.655172413793103 GHz ---
--- Frequency: 18.06896551724138 GHz ---
--- Frequency: 21.482758620689655 GHz ---
--- Frequency: 24.89655172413793 GHz ---
--- Frequency: 28.310344827586206 GHz ---
--- Frequency: 31.724137931034484 GHz ---
--- Frequency: 35.13793103448276 GHz ---
--- Frequency: 38.55172413793103 GHz ---
--- Frequency: 41.96551724137931 GHz ---
--- Frequency: 45.37931034482759 GHz ---
--- Frequency: 48.79310344827586 GHz ---
--- Frequency: 52.206896551724135 GHz ---
--- Frequency: 55.62068965517241 GHz ---
--- Frequency: 59.03448275862069 GHz ---
--- Frequency: 62.44827586206897 GHz ---
--- Frequency: 65.86206896551724 GHz ---
--- Frequency: 69.27586206896552 GHz ---
--- Frequency: 72.6896551724138 GHz ---
--- Frequency: 76.10344827586206 GHz ---
--- Frequency: 79.51724137931035 GHz ---
--- Frequency: 82.93103448275862 GHz ---
--- Frequency: 86.34482758620689 GHz ---
--- Frequency: 89.75862068965517 GHz ---
--- Frequency: 93.17241379310344 GHz ---
--- Frequency: 96.58620689655172 GHz ---
--- Frequency: 100.0 GHz ---
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax_neff</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax_loss</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_Z0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax_s11</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax_s12</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">ax_neff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_values</span><span class="p">[:</span><span class="n">a</span><span class="p">],</span> <span class="n">neff_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">a</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">ax_loss</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_values</span><span class="p">[:</span><span class="n">a</span><span class="p">],</span> <span class="n">loss_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">a</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="c1"># ax_Z0.plot(freq_values[:a], Z0_values[i, :a].real, label=f&#39;Mode {i} (Re)&#39;, marker=&#39;o&#39;)</span>
    <span class="c1"># ax_Z0.plot(freq_values[:a], Z0_values[i, :a].imag, label=f&#39;Mode {i} (Im)&#39;, marker=&#39;o&#39;)</span>
    <span class="n">ax_Z0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_values</span><span class="p">[:</span><span class="n">a</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Z0_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">a</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (Abs)&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">ax_s11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_values</span><span class="p">[:</span><span class="n">a</span><span class="p">],</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s11_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">a</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (Re)&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">ax_s12</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freq_values</span><span class="p">[:</span><span class="n">a</span><span class="p">],</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s12_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">a</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (Re)&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="c1"># ax_neff.set_ylim(2,5)</span>
<span class="n">ax_neff</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">ax_neff</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effective index&#39;</span><span class="p">)</span>

<span class="n">ax_loss</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">ax_loss</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss (dB/cm)&#39;</span><span class="p">)</span>

<span class="n">ax_Z0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">ax_Z0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Characteristic impedance (Ohm)&#39;</span><span class="p">)</span>

<span class="n">ax_s11</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">ax_s11</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;S11 (dB)&#39;</span><span class="p">)</span>

<span class="n">ax_s12</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
<span class="n">ax_s12</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;S12 (dB)&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_22_0.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_22_0.png" />
</div>
</div>
</section>
<section id="Voltage-sweep">
<h2>Voltage sweep<a class="headerlink" href="#Voltage-sweep" title="Link to this heading">ÔÉÅ</a></h2>
<p>Since we now have voltage data information, it becomes simple to study how the small signal characteristics are expected to vary with voltage. This will innevitably be a measure of how linear the electrical propagation will be.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">V_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]))</span>

<span class="n">n_modes</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">neff_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">V_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">loss_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">V_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">Z0_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">V_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">s11_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">V_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">s12_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">V_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">V_values</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--- Voltage: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> V ---&#39;</span><span class="p">)</span>
    <span class="n">rf_sim</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">metallic_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">],</span>
        <span class="n">voltage_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">n_guess</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">num_modes</span> <span class="o">=</span> <span class="n">n_modes</span><span class="p">,</span>
        <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">return_modes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">use_charge_transport_data</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>


    <span class="c1">#Let us select the mode that has a positive value for loss</span>
    <span class="c1">#The current geometry will only allow for one physical mode. We are purposely calculating two modes, but one of them will be some radiative mode with negative loss (gain).</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_modes</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span> <span class="c1">#dB/cm</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">i0_all</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">get_currents</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">p0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p0</span> <span class="c1">#This correction is needed as the power of the actual field we are interested in is twice of the one calculated by the simulator</span>
        <span class="n">I0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i0_all</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">]</span>

        <span class="n">Z0</span> <span class="o">=</span> <span class="n">p0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">I0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">s11</span><span class="p">,</span> <span class="n">s12</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">get_S</span><span class="p">(</span>
            <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">k</span> <span class="p">,</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">Z0</span> <span class="p">,</span>
            <span class="n">ZL</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">ZS</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">L</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="c1">#um</span>
        <span class="p">)</span>


        <span class="n">neff_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span>
        <span class="n">loss_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf_sim</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span> <span class="c1">#dB/cm</span>
        <span class="n">Z0_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z0</span>
        <span class="n">s11_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s11</span>
        <span class="n">s12_values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s12</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Voltage: 0.0 V ---
--- Voltage: 0.3 V ---
--- Voltage: 0.6 V ---
--- Voltage: 0.8999999999999999 V ---
--- Voltage: 1.2 V ---
--- Voltage: 1.5 V ---
--- Voltage: 1.7999999999999998 V ---
--- Voltage: 2.1 V ---
--- Voltage: 2.4 V ---
--- Voltage: 2.6999999999999997 V ---
--- Voltage: 3.0 V ---
--- Voltage: 3.3 V ---
--- Voltage: 3.5999999999999996 V ---
--- Voltage: 3.9 V ---
--- Voltage: 4.2 V ---
--- Voltage: 4.5 V ---
--- Voltage: 4.8 V ---
--- Voltage: 5.1 V ---
--- Voltage: 5.3999999999999995 V ---
--- Voltage: 5.7 V ---
--- Voltage: 6.0 V ---
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax_neff</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax_loss</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_Z0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax_s11</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax_s12</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">ax_neff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">neff_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">ax_loss</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">loss_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">ax_Z0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Z0_values</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (Abs)&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">ax_s11</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s11_values</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (Re)&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">ax_s12</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s12_values</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (Re)&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="c1"># ax_neff.set_ylim(2.5,4)</span>
<span class="n">ax_neff</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bias voltage (V)&#39;</span><span class="p">)</span>
<span class="n">ax_neff</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effective index&#39;</span><span class="p">)</span>

<span class="n">ax_loss</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bias voltage (V)&#39;</span><span class="p">)</span>
<span class="n">ax_loss</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss (dB/cm)&#39;</span><span class="p">)</span>

<span class="n">ax_Z0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bias voltage (V)&#39;</span><span class="p">)</span>
<span class="n">ax_Z0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Characteristic impedance (Ohm)&#39;</span><span class="p">)</span>

<span class="n">ax_s11</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bias voltage (V)&#39;</span><span class="p">)</span>
<span class="n">ax_s11</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;S11 (dB)&#39;</span><span class="p">)</span>

<span class="n">ax_s12</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Bias voltage (V)&#39;</span><span class="p">)</span>
<span class="n">ax_s12</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;S12 (dB)&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Driving frequency = 20 GHz&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_25_0.png" src="../../_images/Tutorials_rf_simulation_charge_transport_rf_simulation_charge_transport_25_0.png" />
</div>
</div>
<p>We can clearly see an improvement on the performance due to the increase of the depletion region size with increasing reverse bias voltage.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../rf_simulation/rf_simulation.html" class="btn btn-neutral float-left" title="RF simulation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../dc_electro_optical/dc_electro_optical.html" class="btn btn-neutral float-right" title="DC electro-optical modulation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Duarte Silva, Kaan S√ºnnet√ßioƒülu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>