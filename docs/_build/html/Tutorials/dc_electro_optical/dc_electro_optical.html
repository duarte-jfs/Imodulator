

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DC electro-optical modulation &mdash; Imodulator 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=7026087e"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Active polarization controller" href="../polarization_converter/polarization_converter.html" />
    <link rel="prev" title="RF simulation with charge transport data" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Imodulator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PhotonicPolygon.html">Photonic Polygons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.name"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.electro_optic_module"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.electro_optic_module</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.electro_optic_module_kwargs"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.electro_optic_module_kwargs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.d_buffer_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.charge_transport_simulator_kwargs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon"><code class="docutils literal notranslate"><span class="pre">MetalPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.name"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.d_buffer_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.charge_transport_simulator_kwargs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.name"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.electro_optic_module"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.electro_optic_module</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.charge_transport_simulator_kwargs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.d_buffer_current</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../PhotonicDevice.html">Photonic Device</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice.__init__"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice.plot_polygons"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice.plot_polygons()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicDevice.html#references">References</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Charge-transport simulators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ChargeSimulators/ChargeSimulatorNN.html">ChargeSimulatorNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ChargeSimulators/ChargeSimulatorSolcore.html">ChargeSimulatorSolcore</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RF mode solvers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../RFSimulators/RFSimulatorFEMWELL.html">RFSimulatorFEMWELL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optical mode solvers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalSimulators/OpticalSimulatorFEMWELL.html">OpticalSimulatorFEMWELL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalSimulators/OpticalSimulatorMODE.html">OpticalSimulatorMODE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Electro Optical models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ElectroOpticalModels/InGaAsPElectroOpticalModel.html">InGaAsPElectroOpticalModel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Electro-optic simulators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ElectroOpticalSimulators/ElectroOpticalSimulator.html">ElectroOpticalSimulator</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../building_photonic_device/building_photonic_device.html">Building a PhotonicDevice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optical_simulation_femwell/optical_simulation_femwell.html">Optical simulation with FEMWELL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../optical_simulation_femwell/optical_simulation_femwell.html#Mesh-refinement">Mesh refinement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../poisson_drift_diffusion_solcore/poisson_drift_diffusion_solcore.html">Solving the poisson-drift-diffusion equation with Solcore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rf_simulation/rf_simulation.html">RF simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Mesh-refinement">Mesh refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Using-a-symmetry-plane">Using a symmetry plane</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Frequency-sweep">Frequency sweep</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html">RF simulation with charge transport data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Solving-the-poisson-drift-diffusion-equation">Solving the poisson-drift-diffusion equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Solving-the-RF-mode">Solving the RF mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Frequency-sweep">Frequency sweep</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Voltage-sweep">Voltage sweep</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DC electro-optical modulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Find-the-optical-mode">Find the optical mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Solve-the-charge-transport-equations">Solve the charge transport equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calculate-the-electro-optic-response">Calculate the electro optic response</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Correcting-PDD-data">Correcting PDD data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../polarization_converter/polarization_converter.html">Active polarization controller</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../polarization_converter/polarization_converter.html#Phase-matching-condition">Phase matching condition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarization_converter/polarization_converter.html#Solving-the-PDD">Solving the PDD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../polarization_converter/polarization_converter.html#Calculate-the-electro-optic-response">Calculate the electro-optic response</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Imodulator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DC electro-optical modulation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Tutorials/dc_electro_optical/dc_electro_optical.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="DC-electro-optical-modulation">
<h1>DC electro-optical modulation<a class="headerlink" href="#DC-electro-optical-modulation" title="Link to this heading">ÔÉÅ</a></h1>
<p>In this tutorial we will explore the DC electro-optical response of a InP based modulator.</p>
<div style="text-align: center;"><p><img alt="Alt text" src="../../_images/main4.png" /></p>
</div><p>To do so, we will use the <code class="docutils literal notranslate"><span class="pre">InP_EOPM</span></code> class created in the <code class="docutils literal notranslate"><span class="pre">Building</span> <span class="pre">a</span> <span class="pre">PhotonicdDevice</span></code> tutorial. It is a InGaAsP-based modulator, which relies on both field and charge effects to modulate light.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">imodulator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openbandparams</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">obp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ElectroOpticalModel</span><span class="w"> </span><span class="kn">import</span> <span class="n">InGaAsPElectroOpticalModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ChargeSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChargeSimulatorSolcore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ElectroOpticalSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElectroOpticalSimulator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.OpticalSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpticalSimulatorFEMWELL</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="k">def</span><span class="w"> </span><span class="nf">tand_fitted_bcb</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitted to results from https://link.springer.com/article/10.1007/s10762-009-9552-0</span>

<span class="sd">    x must be in GHz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span>  <span class="mf">0.0093839</span> <span class="o">-</span> <span class="mf">0.01790336</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.04773444</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="o">-</span><span class="mf">4.64170761</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InP_EOPM</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="mf">1.60e-19</span> <span class="c1"># electron charge in C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e0</span> <span class="o">=</span> <span class="mf">8.85e-12</span> <span class="c1"># vacuum permittivity in F/m</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Width of signal metal in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Separation between signal and ground metals in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Height of metals in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">=</span> <span class="mf">0.2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_top</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="k">for</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_meshes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># optical mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># RF mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># eo mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#We will now set the RF properties of the metals and the BCB</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">#GHz. This will be the simulation frequency</span>

        <span class="n">eps_rf_metal</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">6e7</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">eps_rf_metal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">freq</span><span class="p">,</span> <span class="n">eps_rf_metal</span><span class="p">])</span>

        <span class="n">bcb_eps_real</span> <span class="o">=</span> <span class="mf">2.65</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">bcb_eps_imag</span> <span class="o">=</span> <span class="n">bcb_eps_real</span> <span class="o">*</span> <span class="n">tand_fitted_bcb</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

        <span class="n">bcb_eps</span> <span class="o">=</span> <span class="n">bcb_eps_real</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">bcb_eps_imag</span>
        <span class="n">bcb_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">freq</span><span class="p">,</span> <span class="n">bcb_eps</span><span class="p">])</span>

        <span class="c1">#Now we create the PhotoPolygons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substrate</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mf">11.7</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;substrate&#39;</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mi">3</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_top</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;background&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mf">3.9</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">3.9</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.44</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;box&#39;</span>
        <span class="p">)</span>

        <span class="n">n_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">n_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">n_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">n_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e18</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">wg1_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mf">0.53</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wg1</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">wg1_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">wg1_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wg1&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mf">0.53</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg1_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e16</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">wg2_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wg2</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">wg2_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">wg2_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wg2&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e16</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p1_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">p1_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">p1_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p1&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Na&#39;</span><span class="p">:</span> <span class="mf">1e17</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p2_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">p2_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">p2_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p2&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">p2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Na&#39;</span><span class="p">:</span> <span class="mf">1e19</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_far_left&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_far_right&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_left&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_right&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_metal</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;sig_metal&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">d_buffer_current</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n_metal_left&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n_metal_right&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">photo_polygons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_metal</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wg2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wg1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">substrate</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="p">]</span>

        <span class="c1">#Just in case there are empty polygons</span>
        <span class="n">idxs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">photo_polygons</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">poly</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="n">idxs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs_to_remove</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">photo_polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">PhotonicDevice</span><span class="p">(</span>
            <span class="n">photo_polygons</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Successfully imported lumapi
WARNING: The RCWA solver will not be available because an S4 installation has not been found.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\solcore\registries.py:73: UserWarning: Optics solver &#39;RCWA&#39; will not be available. An installation of S4 has not been found.
  warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Successfully imported nextnanopy
Successfully configured nextnano++ settings
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\nextnanopy\defaults.py:202: UserWarning: Unsupported products in config file: [&#39;nextnano.NEGF++&#39;] will be ignored. To not see this message, please remove unsupported products from the config file: C:\Users\20230622\.nextnanopy-configNote: nextnano.NEGF++ was renamed to nextnano.NEGF, nextnano.NEGF was renamed to nextnano.NEGF_classic. Please check the documentation for more details.
  warnings.warn(
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eopm</span> <span class="o">=</span> <span class="n">InP_EOPM</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_make_meshes</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_create_polygons</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_initialize_device</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]:</span>
    <span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">(</span>
        <span class="n">color_polygon</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">color_line</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="n">color_junctions</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="n">fill_polygons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (um)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (um)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_2_0.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_2_0.png" />
</div>
</div>
<section id="Find-the-optical-mode">
<h2>Find the optical mode<a class="headerlink" href="#Find-the-optical-mode" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mode</span> <span class="o">=</span> <span class="n">OpticalSimulatorFEMWELL</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_window</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">include_metals</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">mode</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">()</span>

<span class="n">mode</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>

<span class="n">mode</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&lt;Figure size 640x480 with 1 Axes&gt;, &lt;Axes: &gt;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_4_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_4_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_4_2.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_4_2.png" />
</div>
</div>
<p>To get nicer results, we will do a mesh refinement step.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modes</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
    <span class="n">wavelength</span><span class="o">=</span><span class="mf">1.55</span><span class="p">,</span>
    <span class="n">num_modes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">metallic_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_guess</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">return_modes</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effective index - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loss - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dB/cm&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#------------------------------------------#&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)):</span>
    <span class="n">mode</span><span class="o">.</span><span class="n">plot_mode</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Effective index - mode 0: 3.2990
loss - mode 0: 59462.25 dB/cm
#------------------------------------------#
Effective index - mode 1: 3.2494
loss - mode 1: 49129.62 dB/cm
#------------------------------------------#
Effective index - mode 2: 3.2201
loss - mode 2: 8.15 dB/cm
#------------------------------------------#
Effective index - mode 3: 3.2179
loss - mode 3: 4.05 dB/cm
#------------------------------------------#
Effective index - mode 4: 3.0602
loss - mode 4: 2339.77 dB/cm
#------------------------------------------#
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_2.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_3.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_4.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_4.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_5.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_6_5.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neff</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nelements</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">mode</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;--- Refinement iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> ---&#39;</span><span class="p">)</span>

    <span class="n">mode</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="mf">1.55</span><span class="p">,</span>
        <span class="n">num_modes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">metallic_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">n_guess</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
        <span class="n">return_modes</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">loss_tmp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
        <span class="n">loss_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

    <span class="n">idx_mode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">loss_tmp</span><span class="p">))</span>
    <span class="c1"># print(&#39;Selected mode index for refinement:&#39;, idx_mode)</span>
    <span class="c1"># print(&#39;Loss of se:&#39;, loss_tmp)</span>

    <span class="n">nelements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nelements</span><span class="p">)</span>
    <span class="n">neff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

    <span class="n">mode</span><span class="o">.</span><span class="n">refine_mesh</span><span class="p">(</span><span class="n">mode_for_refinement</span><span class="o">=</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;neff: </span><span class="si">{</span><span class="n">neff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">, loss: </span><span class="si">{</span><span class="n">loss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dB/cm, nelements: </span><span class="si">{</span><span class="n">nelements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- Refinement iteration 0 ---
neff: 3.217871, loss: 4.05 dB/cm, nelements: 1061
--- Refinement iteration 1 ---
neff: 3.217228, loss: 3.64 dB/cm, nelements: 1101
--- Refinement iteration 2 ---
neff: 3.212777, loss: 4.17 dB/cm, nelements: 1255
--- Refinement iteration 3 ---
neff: 3.215660, loss: 9.88 dB/cm, nelements: 1429
--- Refinement iteration 4 ---
neff: 3.215910, loss: 10.84 dB/cm, nelements: 1573
--- Refinement iteration 5 ---
neff: 3.212015, loss: 5.02 dB/cm, nelements: 1895
--- Refinement iteration 6 ---
neff: 3.215393, loss: 11.67 dB/cm, nelements: 2075
--- Refinement iteration 7 ---
neff: 3.215521, loss: 11.68 dB/cm, nelements: 2299
--- Refinement iteration 8 ---
neff: 3.214702, loss: 12.46 dB/cm, nelements: 2823
--- Refinement iteration 9 ---
neff: 3.208150, loss: 5.39 dB/cm, nelements: 3639
--- Refinement iteration 10 ---
neff: 3.207441, loss: 5.48 dB/cm, nelements: 3849
--- Refinement iteration 11 ---
neff: 3.206677, loss: 5.57 dB/cm, nelements: 4173
--- Refinement iteration 12 ---
neff: 3.206582, loss: 5.59 dB/cm, nelements: 4261
--- Refinement iteration 13 ---
neff: 3.206202, loss: 5.61 dB/cm, nelements: 4633
--- Refinement iteration 14 ---
neff: 3.206064, loss: 5.63 dB/cm, nelements: 4741
--- Refinement iteration 15 ---
neff: 3.205495, loss: 5.54 dB/cm, nelements: 5603
--- Refinement iteration 16 ---
neff: 3.205370, loss: 5.53 dB/cm, nelements: 5867
--- Refinement iteration 17 ---
neff: 3.205281, loss: 5.50 dB/cm, nelements: 5993
--- Refinement iteration 18 ---
neff: 3.205066, loss: 5.37 dB/cm, nelements: 7237
--- Refinement iteration 19 ---
neff: 3.204929, loss: 5.38 dB/cm, nelements: 7795
--- Refinement iteration 20 ---
neff: 3.204620, loss: 3.58 dB/cm, nelements: 9871
--- Refinement iteration 21 ---
neff: 3.204576, loss: 3.58 dB/cm, nelements: 10371
--- Refinement iteration 22 ---
neff: 3.204493, loss: 3.47 dB/cm, nelements: 12587
--- Refinement iteration 23 ---
neff: 3.204461, loss: 3.46 dB/cm, nelements: 12939
--- Refinement iteration 24 ---
neff: 3.204304, loss: 3.30 dB/cm, nelements: 18311
--- Refinement iteration 25 ---
neff: 3.204280, loss: 3.30 dB/cm, nelements: 19193
--- Refinement iteration 26 ---
neff: 3.204114, loss: 3.25 dB/cm, nelements: 22691
--- Refinement iteration 27 ---
neff: 3.204066, loss: 3.25 dB/cm, nelements: 23335
--- Refinement iteration 28 ---
neff: 3.204063, loss: 3.25 dB/cm, nelements: 23363
--- Refinement iteration 29 ---
neff: 3.203968, loss: 3.23 dB/cm, nelements: 25889
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">n_iterations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nelements</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">neff</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_iterations</span><span class="p">,</span> <span class="n">nelements</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Refinement iteration&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Refinement iteration&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Refinement iteration&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effective index (Re)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Propagation loss (dB/m)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of elements&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_8_0.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_8_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mode</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&lt;Figure size 640x480 with 1 Axes&gt;, &lt;Axes: &gt;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_9_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_9_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">modes</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="mf">1.55</span><span class="p">,</span>
        <span class="n">num_modes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">metallic_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">n_guess</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
        <span class="n">return_modes</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effective index - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loss - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dB/cm&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#------------------------------------------#&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)):</span>
    <span class="n">mode</span><span class="o">.</span><span class="n">plot_mode</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Effective index - mode 0: 3.2451
loss - mode 0: 57154.94 dB/cm
#------------------------------------------#
Effective index - mode 1: 3.2109
loss - mode 1: 8.53 dB/cm
#------------------------------------------#
Effective index - mode 2: 3.2040
loss - mode 2: 3.23 dB/cm
#------------------------------------------#
Effective index - mode 3: 3.1848
loss - mode 3: 43124.54 dB/cm
#------------------------------------------#
Effective index - mode 4: 3.0481
loss - mode 4: 2559.31 dB/cm
#------------------------------------------#
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_2.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_3.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_4.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_4.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_5.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_10_5.png" />
</div>
</div>
<p>Now that we have found our modes, we will transfer the TE and TM modes to the <code class="docutils literal notranslate"><span class="pre">PhotonicDevice</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mode</span><span class="o">.</span><span class="n">transfer_results_to_device</span><span class="p">(</span>
    <span class="n">TE_TM_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\skfem\assembly\form\linear_form.py:44: ComplexWarning: Casting complex values to real discards the imaginary part
  data[ixs] = self._kernel(vbasis.basis[i], w, dx)
</pre></div></div>
</div>
</section>
<section id="Solve-the-charge-transport-equations">
<h2>Solve the charge transport equations<a class="headerlink" href="#Solve-the-charge-transport-equations" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">+</span><span class="mf">0.01</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_n</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg2</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">]])</span> <span class="c1">#simulation line</span>

<span class="n">charge</span><span class="o">=</span><span class="n">ChargeSimulatorSolcore</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_line</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
    <span class="n">bias_start_stop_step</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">21</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">plot_with_simulation_line</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="n">charge</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Charge transport will take place with:
p2
p1
wg2
wg1
n
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_14_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_14_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_14_2.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_14_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">solve_PDD</span><span class="p">(</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">smooth_output</span><span class="o">=</span><span class="kc">True</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">charge</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span>
    <span class="n">V_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Material &#34;n&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Solving IV of the junctions...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\solcore\sesame_drift_diffusion\solve_pdd.py:193: UserWarning: All voltages are positive, but junction has been identified as n-p, so the  open-circuit voltage (Voc) of the junction will be negative.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Solving IV of the tunnel junctions...
Solving IV of the total solar cell...
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_15_3.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_15_3.png" />
</div>
</div>
<p>And now we transfer again the results to the `<code class="docutils literal notranslate"><span class="pre">PhotonicDevice</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">transfer_results_to_device</span><span class="p">(</span><span class="n">xmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Calculate-the-electro-optic-response">
<h2>Calculate the electro optic response<a class="headerlink" href="#Calculate-the-electro-optic-response" title="Link to this heading">ÔÉÅ</a></h2>
<p>We now have all the data necessary to perform the electro-optic calculations. We start by initializing the <code class="docutils literal notranslate"><span class="pre">ElectroOpticSimulator</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EO</span><span class="o">=</span><span class="n">ElectroOpticalSimulator</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_window</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">EO</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
<span class="n">EO</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (um)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;y (um)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_19_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_19_1.png" />
</div>
</div>
<p>We can now calculate the <span class="math notranslate nohighlight">\(\Delta \bar{\epsilon}(x,y,V)\)</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EO</span><span class="o">.</span><span class="n">get_epsilon_optical</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\numpy\numpy_func.py:322: RuntimeWarning: invalid value encountered in sqrt
  result_magnitude = func(*stripped_args, **stripped_kwargs)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1271: RuntimeWarning: invalid value encountered in power
  magnitude = new_self._magnitude**exponent
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1271: RuntimeWarning: invalid value encountered in sqrt
  magnitude = new_self._magnitude**exponent
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1006: RuntimeWarning: divide by zero encountered in divide
  magnitude = magnitude_op(new_self._magnitude, other._magnitude)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1006: RuntimeWarning: invalid value encountered in divide
  magnitude = magnitude_op(new_self._magnitude, other._magnitude)
C:\Users\20230622\OneDrive - TU Eindhoven\PhD\Python packages\photonmod\src\imodulator\ElectroOpticalSimulator.py:367: UnitStrippedWarning: The unit of the quantity is stripped when downcasting to ndarray.
  epsilon_optical_all[EO_model_name][&#39;dperms&#39;][:, :, vertices_idxs, voltage_idx, perm_idx] = perm
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\numpy\numpy_func.py:322: RuntimeWarning: invalid value encountered in log
  result_magnitude = func(*stripped_args, **stripped_kwargs)
</pre></div></div>
</div>
<p>It is instructive to understand the structure of the <code class="docutils literal notranslate"><span class="pre">EO.epsilon_optical</span></code> object as it became quite complex out of necessity to allow for future models. This object is stored as a dictionary. Each key of this dictionary aims to capture the effects induced by an <code class="docutils literal notranslate"><span class="pre">ElectroOpticalModel</span></code>. In our case we have only <code class="docutils literal notranslate"><span class="pre">InGaAsPElectroOpticalModel</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([&#39;InGaAsPElectroOpticalModel&#39;])
</pre></div></div>
</div>
<p>Now, each key to an <code class="docutils literal notranslate"><span class="pre">ElectroOpticalModel</span></code> is again a dictionary because it can happen that a single <code class="docutils literal notranslate"><span class="pre">ElectroOpticalModel</span></code> has various contributions to the overall electro-optic response. For example, the <code class="docutils literal notranslate"><span class="pre">InGaAsPElectroOpticalModel</span></code> has 5 different contributions: 3 charge effects (plasma, band-filling and intervalence effects) and 2 field effects (pockels and kerr). It may be useful for you, as a designer to account for this distinction. For example if you design for 100GHz+ you may want
to focus on optimizing field effects rather than charge effects since they are fundamentally limited. If you are designing for lower frequencies you may be interested in a balance between charge effects and field effects. The structure of this nested dictionary gives you two keys: <code class="docutils literal notranslate"><span class="pre">dperms</span></code> and <code class="docutils literal notranslate"><span class="pre">labels</span></code>. The <code class="docutils literal notranslate"><span class="pre">dperms</span></code> are the actual changes in permitivity induced by the various effects, and the <code class="docutils literal notranslate"><span class="pre">labels</span></code> is just a list which lets you retrieve the <code class="docutils literal notranslate"><span class="pre">dperm</span></code> for each of the effects. The
<code class="docutils literal notranslate"><span class="pre">dperms</span></code> array has a shape of the shape [3,3,mesh points, voltage values, effects].</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;dperms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([&#39;dperms&#39;, &#39;labels&#39;])
(3, 3, 2247, 21, 5)
[&#39;Bandfilling&#39;, &#39;Plasma&#39;, &#39;Intervalence&#39;, &#39;Pockels&#39;, &#39;Kerr&#39;]
</pre></div></div>
</div>
<p>Armed with this information we can actually inspect the <span class="math notranslate nohighlight">\(\Delta \bar{\epsilon}\)</span> for the various effects:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here we will inspect some of the calculated properties</span>
<span class="c1"># We know we are working with InGaAsP materials so we&#39;ll focus on those ElectroOpticalModel properties</span>

<span class="n">V_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">])</span>
<span class="n">idx_voltage1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">idx_voltage2</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">]</span>

<span class="n">tensor_elements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">idx_effect</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">e11</span><span class="p">,</span><span class="n">e22</span> <span class="o">=</span> <span class="n">tensor_elements</span><span class="p">[</span><span class="n">idx_effect</span><span class="p">]</span>
    <span class="n">eps1</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;dperms&#39;</span><span class="p">][</span><span class="n">e11</span><span class="p">,</span><span class="n">e22</span><span class="p">,</span> <span class="p">:,</span> <span class="n">idx_voltage1</span><span class="p">,</span> <span class="n">idx_effect</span><span class="p">]</span>
    <span class="n">eps2</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;dperms&#39;</span><span class="p">][</span><span class="n">e11</span><span class="p">,</span><span class="n">e22</span><span class="p">,</span> <span class="p">:,</span> <span class="n">idx_voltage2</span><span class="p">,</span> <span class="n">idx_effect</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="n">idx_effect</span><span class="p">]</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx_effect</span><span class="p">]</span>

    <span class="n">EO</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">eps2</span> <span class="o">-</span> <span class="n">eps1</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># scat= ax.scatter(</span>
    <span class="c1">#     EO.mesh.p[0],</span>
    <span class="c1">#     EO.mesh.p[1],</span>
    <span class="c1">#     c=(eps2 - eps1).imag,</span>
    <span class="c1"># )</span>
    <span class="c1"># fig.colorbar(scat, ax=ax, label=f&#39;Imaginary part of $\\Delta \\epsilon_{{{e11,e22}}}$&#39;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> $</span><span class="se">\\</span><span class="s1">epsilon_</span><span class="se">{{</span><span class="si">{</span><span class="n">e11</span><span class="p">,</span><span class="n">e22</span><span class="si">}</span><span class="se">}}</span><span class="s1">$ </span><span class="se">\n</span><span class="s1">(V=</span><span class="si">{</span><span class="n">V_values</span><span class="p">[</span><span class="n">idx_voltage2</span><span class="p">]</span><span class="si">}</span><span class="s1"> V - </span><span class="si">{</span><span class="n">V_values</span><span class="p">[</span><span class="n">idx_voltage1</span><span class="p">]</span><span class="si">}</span><span class="s1"> V)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">EO</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">(</span><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>


<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_27_0.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_27_0.png" />
</div>
</div>
<p>Finally, we can calculate the electro-optic response, considering the overlap with the optical field. In the following, we will consider the following:</p>
<ul class="simple">
<li><p>We are intered in phase modulation of the TE and TM modes. Cross modulation will be explored in another tutorial.</p></li>
<li><p>We will rotate the permitivity around the y axis by 45deg so that the contribution of the pockels effect is positive.</p></li>
<li><p>We will calculate the electro-optic response with respect to 0V.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Calculate the EO response for all voltages</span>
<span class="n">all_res_TE</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_res_TM</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">])):</span>
    <span class="n">kappa_aa</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">calculate_EO_response</span><span class="p">(</span>
        <span class="n">voltage_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">rot_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">rot_y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">rot_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">base_epsilon_voltage_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">optical_mode_a</span><span class="o">=</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span>
        <span class="n">optical_mode_b</span><span class="o">=</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kappa_bb</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">calculate_EO_response</span><span class="p">(</span>
        <span class="n">voltage_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">rot_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">rot_y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">rot_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">base_epsilon_voltage_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">optical_mode_a</span><span class="o">=</span><span class="s1">&#39;TM&#39;</span><span class="p">,</span>
        <span class="n">optical_mode_b</span><span class="o">=</span><span class="s1">&#39;TM&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">## Adjust to have phase change</span>

    <span class="n">all_res_TE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kappa_aa</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
    <span class="n">all_res_TM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kappa_bb</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
    <span class="c1"># print(res[&#39;InGaAsPElectroOpticalModel&#39;][&#39;results&#39;].real*1e-3)</span>
<span class="n">all_res_TE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_res_TE</span><span class="p">)</span>
<span class="n">all_res_TM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_res_TM</span><span class="p">)</span>

<span class="k">for</span> <span class="n">all_res</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">all_res_TE</span><span class="p">,</span> <span class="n">all_res_TM</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">]):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">all_res</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kappa_aa</span><span class="p">[</span><span class="s2">&quot;InGaAsPElectroOpticalModel&quot;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">all_res</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sum&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Phase change (rad)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Electro refraction&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">conversion_factor</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># ‚âà 8.686</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">all_res</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">conversion_factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kappa_aa</span><span class="p">[</span><span class="s2">&quot;InGaAsPElectroOpticalModel&quot;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">all_res</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">conversion_factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sum&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss (dB)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Electro absorption&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Device length 1 mm - </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> mode&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">all_res</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">all_res_TE</span><span class="p">,</span> <span class="n">all_res_TM</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">]):</span>
    <span class="n">Eout</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_res</span><span class="o">*</span><span class="mf">3e-3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Eout</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Iout</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> mode&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (dB)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MZM output&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_29_0.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_29_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_29_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_29_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_29_2.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_29_2.png" />
</div>
</div>
<p>At this point it is important that we analyze the data. A very worrying feature has popped up in the results above: the Kerr effect seems to be inducing gain. This is not physical since the kerr effect will start inducing loss rather than gain at 1550nm with high voltage, and we must understand why. As far as we know, when this happens it is usually something to do with bad data rather than wrong mathematics (but it can happen! If you find a mistake, please let us know). In this case, when
analyze the effects in the previous step, we find that there seems to be something happening at the InGaAsP/InP boundary. Not only there is a big charge depletion as there also exist a sudden change in the band energies both of which impact greatly the Kerr effect in InGaAsP alloys. This is where optimizing the PDD solver is crucial, as these details can completely change the behaviour of your electro-optical modulator, and you must be aware of your structure and if such barriers are actually
physical. In our case, we have found that a simple smoothing of the data from the PDD solver return physically sensible results</p>
</section>
<section id="Correcting-PDD-data">
<h2>Correcting PDD data<a class="headerlink" href="#Correcting-PDD-data" title="Link to this heading">ÔÉÅ</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">+</span><span class="mf">0.01</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_n</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg2</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">]])</span> <span class="c1">#simulation line</span>

<span class="n">charge</span><span class="o">=</span><span class="n">ChargeSimulatorSolcore</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_line</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
    <span class="n">bias_start_stop_step</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">51</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">charge</span><span class="o">.</span><span class="n">solve_PDD</span><span class="p">(</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">smooth_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">charge</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span>
    <span class="n">V_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Charge transport will take place with:
p2
p1
wg2
wg1
n
Material &#34;n&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Solving IV of the junctions...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\solcore\sesame_drift_diffusion\solve_pdd.py:193: UserWarning: All voltages are positive, but junction has been identified as n-p, so the  open-circuit voltage (Voc) of the junction will be negative.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Solving IV of the tunnel junctions...
Solving IV of the total solar cell...
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_31_3.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_31_3.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">transfer_results_to_device</span><span class="p">(</span><span class="n">xmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EO</span><span class="o">=</span><span class="n">ElectroOpticalSimulator</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_window</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">EO</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
<span class="n">EO</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (um)&#39;</span><span class="p">)</span>

<span class="n">EO</span><span class="o">.</span><span class="n">get_epsilon_optical</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\numpy\numpy_func.py:322: RuntimeWarning: invalid value encountered in sqrt
  result_magnitude = func(*stripped_args, **stripped_kwargs)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1006: RuntimeWarning: divide by zero encountered in divide
  magnitude = magnitude_op(new_self._magnitude, other._magnitude)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1006: RuntimeWarning: invalid value encountered in divide
  magnitude = magnitude_op(new_self._magnitude, other._magnitude)
C:\Users\20230622\OneDrive - TU Eindhoven\PhD\Python packages\photonmod\src\imodulator\ElectroOpticalSimulator.py:367: UnitStrippedWarning: The unit of the quantity is stripped when downcasting to ndarray.
  epsilon_optical_all[EO_model_name][&#39;dperms&#39;][:, :, vertices_idxs, voltage_idx, perm_idx] = perm
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\numpy\numpy_func.py:322: RuntimeWarning: invalid value encountered in log
  result_magnitude = func(*stripped_args, **stripped_kwargs)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1271: RuntimeWarning: invalid value encountered in power
  magnitude = new_self._magnitude**exponent
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1271: RuntimeWarning: invalid value encountered in sqrt
  magnitude = new_self._magnitude**exponent
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_33_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_33_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here we will inspect some of the calculated properties</span>
<span class="c1"># We know we are working with InGaAsP materials so we&#39;ll focus on those ElectroOpticalModel properties</span>

<span class="n">V_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">])</span>
<span class="n">idx_voltage1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">idx_voltage2</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">]</span>

<span class="n">tensor_elements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">idx_effect</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">e11</span><span class="p">,</span><span class="n">e22</span> <span class="o">=</span> <span class="n">tensor_elements</span><span class="p">[</span><span class="n">idx_effect</span><span class="p">]</span>
    <span class="n">eps1</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;dperms&#39;</span><span class="p">][</span><span class="n">e11</span><span class="p">,</span><span class="n">e22</span><span class="p">,</span> <span class="p">:,</span> <span class="n">idx_voltage1</span><span class="p">,</span> <span class="n">idx_effect</span><span class="p">]</span>
    <span class="n">eps2</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;dperms&#39;</span><span class="p">][</span><span class="n">e11</span><span class="p">,</span><span class="n">e22</span><span class="p">,</span> <span class="p">:,</span> <span class="n">idx_voltage2</span><span class="p">,</span> <span class="n">idx_effect</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">epsilon_optical</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="n">idx_effect</span><span class="p">]</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx_effect</span><span class="p">]</span>

    <span class="n">EO</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">eps2</span> <span class="o">-</span> <span class="n">eps1</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># scat= ax.scatter(</span>
    <span class="c1">#     EO.mesh.p[0],</span>
    <span class="c1">#     EO.mesh.p[1],</span>
    <span class="c1">#     c=(eps2 - eps1).imag,</span>
    <span class="c1"># )</span>
    <span class="c1"># fig.colorbar(scat, ax=ax, label=f&#39;Imaginary part of $\\Delta \\epsilon_{{{e11,e22}}}$&#39;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> $</span><span class="se">\\</span><span class="s1">epsilon_</span><span class="se">{{</span><span class="si">{</span><span class="n">e11</span><span class="p">,</span><span class="n">e22</span><span class="si">}</span><span class="se">}}</span><span class="s1">$ </span><span class="se">\n</span><span class="s1">(V=</span><span class="si">{</span><span class="n">V_values</span><span class="p">[</span><span class="n">idx_voltage2</span><span class="p">]</span><span class="si">}</span><span class="s1"> V - </span><span class="si">{</span><span class="n">V_values</span><span class="p">[</span><span class="n">idx_voltage1</span><span class="p">]</span><span class="si">}</span><span class="s1"> V)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">EO</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">(</span><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>


<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_34_0.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_34_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Calculate the EO response for all voltages</span>
<span class="n">all_res_TE</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_res_TM</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">])):</span>
    <span class="n">kappa_aa</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">calculate_EO_response</span><span class="p">(</span>
        <span class="n">voltage_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">rot_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">rot_y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">rot_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">base_epsilon_voltage_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">optical_mode_a</span><span class="o">=</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span>
        <span class="n">optical_mode_b</span><span class="o">=</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kappa_bb</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">calculate_EO_response</span><span class="p">(</span>
        <span class="n">voltage_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
        <span class="n">rot_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">rot_y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">rot_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">base_epsilon_voltage_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">optical_mode_a</span><span class="o">=</span><span class="s1">&#39;TM&#39;</span><span class="p">,</span>
        <span class="n">optical_mode_b</span><span class="o">=</span><span class="s1">&#39;TM&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">## Adjust to have phase change</span>

    <span class="n">all_res_TE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kappa_aa</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
    <span class="n">all_res_TM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kappa_bb</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
    <span class="c1"># print(res[&#39;InGaAsPElectroOpticalModel&#39;][&#39;results&#39;].real*1e-3)</span>
<span class="n">all_res_TE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_res_TE</span><span class="p">)</span>
<span class="n">all_res_TM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_res_TM</span><span class="p">)</span>

<span class="k">for</span> <span class="n">all_res</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">all_res_TE</span><span class="p">,</span> <span class="n">all_res_TM</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">]):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">all_res</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kappa_aa</span><span class="p">[</span><span class="s2">&quot;InGaAsPElectroOpticalModel&quot;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">all_res</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sum&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Phase change (rad)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Electro refraction&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">conversion_factor</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># ‚âà 8.686</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">all_res</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="n">conversion_factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kappa_aa</span><span class="p">[</span><span class="s2">&quot;InGaAsPElectroOpticalModel&quot;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">all_res</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">conversion_factor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sum&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss (dB)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Electro absorption&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Device length 1 mm - </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> mode&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">all_res</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">all_res_TE</span><span class="p">,</span> <span class="n">all_res_TM</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">]):</span>
    <span class="n">Eout</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_res</span><span class="o">*</span><span class="mf">3e-3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Eout</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V_values</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Iout</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> mode&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (dB)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MZM output for a 3mm device&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_35_0.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_35_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_35_1.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_35_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_35_2.png" src="../../_images/Tutorials_dc_electro_optical_dc_electro_optical_35_2.png" />
</div>
</div>
<p>We now have a far more sensible solution. With this, we can now make some conclusions:</p>
<ul class="simple">
<li><p>As you can see, in these kind of modulators, there is quite a significant contribution from the charge effects.</p></li>
<li><p>There seems to be some gain from the intervalence effects. This is something that is visible even in experiments. The origin of it stems from the depletion of p dopants from the depletion region. These have a very strong absorption, and even depleting a few carriers can make a significant contribution to the change in loss.</p></li>
<li><p>The TM and TE mode have very distinct <span class="math notranslate nohighlight">\(V_\pi\)</span>. This stems from the difference in the effect that the pockels effect has.</p></li>
<li><p>The TM mode does not have a 0 contribution from the pockels effect. This stems from the fact that our TE and TM modes are not pure TE and pure TM, so we are bound to have some cross modulation. The fact that the pockels contribution of the TM mode is negative tells us that the ersponsible for it is the Z component of the field rather than the x component.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html" class="btn btn-neutral float-left" title="RF simulation with charge transport data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../polarization_converter/polarization_converter.html" class="btn btn-neutral float-right" title="Active polarization controller" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Duarte Silva, Kaan S√ºnnet√ßioƒülu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>