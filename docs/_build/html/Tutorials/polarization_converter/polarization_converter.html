

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Active polarization controller &mdash; Imodulator 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=7026087e"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="DC electro-optical modulation" href="../dc_electro_optical/dc_electro_optical.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Imodulator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PhotonicPolygon.html">Photonic Polygons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.name"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.electro_optic_module"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.electro_optic_module</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.electro_optic_module_kwargs"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.electro_optic_module_kwargs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.d_buffer_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.SemiconductorPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">SemiconductorPolygon.charge_transport_simulator_kwargs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon"><code class="docutils literal notranslate"><span class="pre">MetalPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.name"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.d_buffer_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.MetalPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">MetalPolygon.charge_transport_simulator_kwargs</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.polygon"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.polygon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.name"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.optical_material"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.optical_material</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.rf_eps"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.rf_eps</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.electro_optic_module"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.electro_optic_module</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.eo_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.eo_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.rf_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.rf_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.optical_mesh_settings"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.optical_mesh_settings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.charge_transport_simulator_kwargs"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.charge_transport_simulator_kwargs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.calculate_current"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.calculate_current</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicPolygon.html#imodulator.PhotonicPolygon.InsulatorPolygon.d_buffer_current"><code class="docutils literal notranslate"><span class="pre">InsulatorPolygon.d_buffer_current</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../PhotonicDevice.html">Photonic Device</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice.__init__"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../PhotonicDevice.html#imodulator.PhotonicDevice.PhotonicDevice.plot_polygons"><code class="docutils literal notranslate"><span class="pre">PhotonicDevice.plot_polygons()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../PhotonicDevice.html#references">References</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Charge-transport simulators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ChargeSimulators/ChargeSimulatorNN.html">ChargeSimulatorNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ChargeSimulators/ChargeSimulatorSolcore.html">ChargeSimulatorSolcore</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RF mode solvers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../RFSimulators/RFSimulatorFEMWELL.html">RFSimulatorFEMWELL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optical mode solvers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalSimulators/OpticalSimulatorFEMWELL.html">OpticalSimulatorFEMWELL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalSimulators/OpticalSimulatorMODE.html">OpticalSimulatorMODE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Electro Optical models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ElectroOpticalModels/InGaAsPElectroOpticalModel.html">InGaAsPElectroOpticalModel</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Electro-optic simulators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ElectroOpticalSimulators/ElectroOpticalSimulator.html">ElectroOpticalSimulator</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../building_photonic_device/building_photonic_device.html">Building a PhotonicDevice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optical_simulation_femwell/optical_simulation_femwell.html">Optical simulation with FEMWELL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../optical_simulation_femwell/optical_simulation_femwell.html#Mesh-refinement">Mesh refinement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../poisson_drift_diffusion_solcore/poisson_drift_diffusion_solcore.html">Solving the poisson-drift-diffusion equation with Solcore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rf_simulation/rf_simulation.html">RF simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Mesh-refinement">Mesh refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Using-a-symmetry-plane">Using a symmetry plane</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation/rf_simulation.html#Frequency-sweep">Frequency sweep</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html">RF simulation with charge transport data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Solving-the-poisson-drift-diffusion-equation">Solving the poisson-drift-diffusion equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Solving-the-RF-mode">Solving the RF mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Frequency-sweep">Frequency sweep</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rf_simulation_charge_transport/rf_simulation_charge_transport.html#Voltage-sweep">Voltage sweep</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html">DC electro-optical modulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Find-the-optical-mode">Find the optical mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Solve-the-charge-transport-equations">Solve the charge transport equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Calculate-the-electro-optic-response">Calculate the electro optic response</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dc_electro_optical/dc_electro_optical.html#Correcting-PDD-data">Correcting PDD data</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Active polarization controller</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Phase-matching-condition">Phase matching condition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Solving-the-PDD">Solving the PDD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Calculate-the-electro-optic-response">Calculate the electro-optic response</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Imodulator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Active polarization controller</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Tutorials/polarization_converter/polarization_converter.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Active-polarization-controller">
<h1>Active polarization controller<a class="headerlink" href="#Active-polarization-controller" title="Link to this heading">ÔÉÅ</a></h1>
<p>In this notebook we want to guide you on how to use this package for the design and simulation of an active polarization controller.</p>
<p>To do so, we will use the <code class="docutils literal notranslate"><span class="pre">InP_EOPM</span></code> class created in the <code class="docutils literal notranslate"><span class="pre">Building</span> <span class="pre">a</span> <span class="pre">PhotonicdDevice</span></code> tutorial.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">imodulator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">openbandparams</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">obp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ElectroOpticalModel</span><span class="w"> </span><span class="kn">import</span> <span class="n">InGaAsPElectroOpticalModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ChargeSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChargeSimulatorSolcore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.ElectroOpticalSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ElectroOpticalSimulator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imodulator.OpticalSimulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpticalSimulatorFEMWELL</span>

<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="k">def</span><span class="w"> </span><span class="nf">tand_fitted_bcb</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitted to results from https://link.springer.com/article/10.1007/s10762-009-9552-0</span>

<span class="sd">    x must be in GHz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span>  <span class="mf">0.0093839</span> <span class="o">-</span> <span class="mf">0.01790336</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.04773444</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="o">-</span><span class="mf">4.64170761</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out</span><span class="o">&lt;</span><span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InP_EOPM</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="mf">1.60e-19</span> <span class="c1"># electron charge in C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e0</span> <span class="o">=</span> <span class="mf">8.85e-12</span> <span class="c1"># vacuum permittivity in F/m</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Width of signal metal in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Separation between signal and ground metals in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Height of metals in um</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">=</span> <span class="mf">0.2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_top</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="k">for</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_meshes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># optical mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># RF mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># eo mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;box&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;bcb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;SizeMax&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;substrate&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
            <span class="s1">&#39;sig_metal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_left&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n_metal_right&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
            <span class="s1">&#39;wg1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">},</span>
            <span class="s1">&#39;wg2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">},</span>
            <span class="s1">&#39;p1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
            <span class="s1">&#39;p2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#We will now set the RF properties of the metals and the BCB</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">#GHz. This will be the simulation frequency</span>

        <span class="n">eps_rf_metal</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">6e7</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="p">)</span>
        <span class="n">eps_rf_metal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">freq</span><span class="p">,</span> <span class="n">eps_rf_metal</span><span class="p">])</span>

        <span class="n">bcb_eps_real</span> <span class="o">=</span> <span class="mf">2.65</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">bcb_eps_imag</span> <span class="o">=</span> <span class="n">bcb_eps_real</span> <span class="o">*</span> <span class="n">tand_fitted_bcb</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>

        <span class="n">bcb_eps</span> <span class="o">=</span> <span class="n">bcb_eps_real</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">bcb_eps_imag</span>
        <span class="n">bcb_eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">freq</span><span class="p">,</span> <span class="n">bcb_eps</span><span class="p">])</span>

        <span class="c1">#Now we create the PhotoPolygons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substrate</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mf">11.7</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;substrate&#39;</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mi">3</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;substrate&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_bottom</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_top</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;background&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_box</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="mf">3.9</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">3.9</span><span class="o">*</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.44</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;box&#39;</span>
        <span class="p">)</span>

        <span class="n">n_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">n_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">n_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">n_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e18</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">wg1_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mf">0.53</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wg1</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">wg1_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">wg1_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wg1&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mf">0.53</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg1_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e16</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">wg2_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wg2</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">wg2_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">wg2_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;wg2&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wg2&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Nd&#39;</span><span class="p">:</span> <span class="mf">1e16</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p1_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInPAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">As</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">p1_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">p1_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p1&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">wg2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Na&#39;</span><span class="p">:</span> <span class="mf">1e17</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">p2_obp_material</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">GaInAs</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">obp</span><span class="o">.</span><span class="n">InP</span><span class="o">.</span><span class="n">a</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">SemiconductorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">p2_obp_material</span><span class="o">.</span><span class="n">dielectric</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="n">p2_obp_material</span><span class="o">.</span><span class="n">refractive_index</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">charge_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge_mesh_settings</span><span class="p">[</span><span class="s1">&#39;p2&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;p2&#39;</span><span class="p">,</span>
            <span class="n">electro_optic_module</span><span class="o">=</span><span class="n">InGaAsPElectroOpticalModel</span><span class="p">,</span>
            <span class="n">electro_optic_module_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                <span class="s1">&#39;BF_model&#39;</span><span class="p">:</span> <span class="s1">&#39;vinchant&#39;</span>
            <span class="p">},</span>
            <span class="n">charge_transport_simulator_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sol_obp_material&#39;</span><span class="p">:</span> <span class="n">p2_obp_material</span><span class="p">,</span>
                <span class="s1">&#39;sol_Na&#39;</span><span class="p">:</span> <span class="mf">1e19</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_far_left&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_far_right&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_left&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bcb_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">InsulatorPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_wg</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">bcb_eps</span><span class="p">,</span>
            <span class="n">optical_material</span><span class="o">=</span><span class="mf">1.56</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;bcb&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;bcb_right&#39;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_metal</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_wg2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;sig_metal&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;sig_metal&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">d_buffer_current</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_left</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_left&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n_metal_left&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_right</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">MetalPolygon</span><span class="p">(</span>
            <span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_sig_metal</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_gnd_metal</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_metal</span>
            <span class="p">),</span>
            <span class="n">rf_eps</span> <span class="o">=</span> <span class="n">eps_rf_metal</span><span class="p">,</span>
            <span class="n">eo_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eo_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">rf_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">optical_mesh_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optical_mesh_settings</span><span class="p">[</span><span class="s1">&#39;n_metal_right&#39;</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;n_metal_right&#39;</span><span class="p">,</span>
            <span class="n">calculate_current</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">photo_polygons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_metal</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_metal_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wg2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wg1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_left</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcb_far_right</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">substrate</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="p">]</span>

        <span class="c1">#Just in case there are empty polygons</span>
        <span class="n">idxs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">photo_polygons</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">poly</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="n">idxs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs_to_remove</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">photo_polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">imodulator</span><span class="o">.</span><span class="n">PhotonicDevice</span><span class="p">(</span>
            <span class="n">photo_polygons</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Successfully imported lumapi
WARNING: The RCWA solver will not be available because an S4 installation has not been found.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\solcore\registries.py:73: UserWarning: Optics solver &#39;RCWA&#39; will not be available. An installation of S4 has not been found.
  warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Successfully imported nextnanopy
Successfully configured nextnano++ settings
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\nextnanopy\defaults.py:202: UserWarning: Unsupported products in config file: [&#39;nextnano.NEGF++&#39;] will be ignored. To not see this message, please remove unsupported products from the config file: C:\Users\20230622\.nextnanopy-configNote: nextnano.NEGF++ was renamed to nextnano.NEGF, nextnano.NEGF was renamed to nextnano.NEGF_classic. Please check the documentation for more details.
  warnings.warn(
</pre></div></div>
</div>
<section id="Phase-matching-condition">
<h2>Phase matching condition<a class="headerlink" href="#Phase-matching-condition" title="Link to this heading">ÔÉÅ</a></h2>
<p>Our first task is to study the modes as a function of the waveguide width in the hopes of finding a phase matching condition. To get some better accuracy we will do 10 mesh refinement steps for each width value and we will use the most TE mode with highest confinement factor in the waveguide core. We will then save the data of only the TE and TM modes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">N_modes</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">N_iterations_refinement</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">neff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">width_values</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">width_values</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">mesh_refinement_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w_wg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">width_values</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulating width </span><span class="si">{</span><span class="n">w_wg</span><span class="si">}</span><span class="s1"> um&#39;</span><span class="p">)</span>

    <span class="n">eopm</span> <span class="o">=</span> <span class="n">InP_EOPM</span><span class="p">(</span>
        <span class="n">w_wg</span> <span class="o">=</span> <span class="n">w_wg</span>
    <span class="p">)</span>

    <span class="n">eopm</span><span class="o">.</span><span class="n">_make_meshes</span><span class="p">()</span>
    <span class="n">eopm</span><span class="o">.</span><span class="n">_create_polygons</span><span class="p">()</span>
    <span class="n">eopm</span><span class="o">.</span><span class="n">_initialize_device</span><span class="p">()</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">OpticalSimulatorFEMWELL</span><span class="p">(</span>
        <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="n">simulation_window</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
        <span class="n">include_metals</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">mode</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>

    <span class="n">neff_ref</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">loss_ref</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nelements_ref</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_iterations_refinement</span><span class="p">):</span>
        <span class="c1">#Just a nice progress bar</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">N_iterations_refinement</span>
        <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="n">j</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mesh refinement [</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">j</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># time.sleep(0.05)</span>

        <span class="n">modes</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
            <span class="n">wavelength</span><span class="o">=</span><span class="mf">1.55</span><span class="p">,</span>
            <span class="n">num_modes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">metallic_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">n_guess</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
            <span class="n">return_modes</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">loss_tmp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="n">loss_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

        <span class="c1"># We will use the mode that is closest to a TE mode for the refinement</span>
        <span class="n">te_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">te_fraction</span> <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
        <span class="n">conf_factors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">elements</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">subdomains</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
            <span class="n">conf_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">calculate_confinement_factor</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>
        <span class="n">conf_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conf_factors</span><span class="p">)</span>

        <span class="n">idx_mode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">conf_factors</span> <span class="o">*</span> <span class="n">te_fractions</span><span class="p">)</span>

        <span class="n">nelements_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nelements</span><span class="p">)</span>
        <span class="n">neff_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="n">loss_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

        <span class="n">mode</span><span class="o">.</span><span class="n">refine_mesh</span><span class="p">(</span><span class="n">mode_for_refinement</span><span class="o">=</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">])</span>

    <span class="n">mesh_refinement_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">w_wg</span><span class="p">,</span>
        <span class="s1">&#39;neff&#39;</span><span class="p">:</span> <span class="n">neff_ref</span><span class="p">,</span>
        <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss_ref</span><span class="p">,</span>
        <span class="s1">&#39;nelements&#39;</span><span class="p">:</span> <span class="n">nelements_ref</span>
    <span class="p">})</span>

    <span class="c1">#Compute the modes</span>
    <span class="n">modes</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
            <span class="n">wavelength</span><span class="o">=</span><span class="mf">1.55</span><span class="p">,</span>
            <span class="n">num_modes</span><span class="o">=</span><span class="n">N_modes</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">metallic_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">n_guess</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
            <span class="n">return_modes</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1">#Find TE and TM modes and store neff and loss</span>
    <span class="n">te_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">te_fraction</span> <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">])</span>
    <span class="n">conf_factors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">subdomains</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
        <span class="n">conf_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">calculate_confinement_factor</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>
    <span class="n">conf_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conf_factors</span><span class="p">)</span>

    <span class="n">TE_TM_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">conf_factors</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>

    <span class="k">if</span> <span class="n">te_fractions</span><span class="p">[</span><span class="n">TE_TM_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">te_fractions</span><span class="p">[</span><span class="n">TE_TM_modes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
        <span class="n">TE_mode_idx</span> <span class="o">=</span> <span class="n">TE_TM_modes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">TM_mode_idx</span> <span class="o">=</span> <span class="n">TE_TM_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">TE_mode_idx</span> <span class="o">=</span> <span class="n">TE_TM_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">TM_mode_idx</span> <span class="o">=</span> <span class="n">TE_TM_modes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">neff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">TE_mode_idx</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span>
    <span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">TE_mode_idx</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>

    <span class="n">neff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">TM_mode_idx</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span>
    <span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">TM_mode_idx</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Simulating width 0.5 um
Simulating width 0.6666666666666666 um#############################] 100%
Simulating width 0.8333333333333333 um#############################] 100%
Simulating width 1.0 um############################################] 100%
Simulating width 1.1666666666666665 um#############################] 100%
Simulating width 1.3333333333333333 um#############################] 100%
Simulating width 1.5 um############################################] 100%
Simulating width 1.6666666666666665 um#############################] 100%
Simulating width 1.8333333333333333 um#############################] 100%
Simulating width 2.0 um############################################] 100%
mesh refinement [##################################################] 100%
</pre></div></div>
</div>
<p>We can now check the effective index of the TE and TM modes</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">width_values</span><span class="p">,</span> <span class="n">neff</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;TE Mode&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">width_values</span><span class="p">,</span> <span class="n">neff</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;TM Mode&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Waveguide width (um)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effective index&#39;</span><span class="p">)</span>

<span class="n">x0</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Width = </span><span class="si">{</span><span class="n">x0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> um&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x277d103c550&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_5_1.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_5_1.png" />
</div>
</div>
<p>Now we calculate the modes again and inspect them</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eopm</span> <span class="o">=</span> <span class="n">InP_EOPM</span><span class="p">(</span>
    <span class="n">w_wg</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="p">)</span>

<span class="n">eopm</span><span class="o">.</span><span class="n">_make_meshes</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_create_polygons</span><span class="p">()</span>
<span class="n">eopm</span><span class="o">.</span><span class="n">_initialize_device</span><span class="p">()</span>

<span class="n">mode</span> <span class="o">=</span> <span class="n">OpticalSimulatorFEMWELL</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_window</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">include_metals</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">mode</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>

<span class="n">neff_ref</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">loss_ref</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nelements_ref</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_iterations_refinement</span><span class="p">):</span>
    <span class="c1">#Just a nice progress bar</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">N_iterations_refinement</span>
    <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="n">j</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mesh refinement [</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">j</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># time.sleep(0.05)</span>

    <span class="n">modes</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="mf">1.55</span><span class="p">,</span>
        <span class="n">num_modes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">metallic_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">n_guess</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
        <span class="n">return_modes</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># We will use the mode that is closest to a TE mode for the refinement</span>
    <span class="n">te_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">te_fraction</span> <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">])</span>
    <span class="n">conf_factors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">subdomains</span><span class="p">[</span><span class="s1">&#39;wg1&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">opt_mode</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
        <span class="n">conf_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt_mode</span><span class="o">.</span><span class="n">calculate_confinement_factor</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>
    <span class="n">conf_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conf_factors</span><span class="p">)</span>

    <span class="n">idx_mode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">conf_factors</span> <span class="o">*</span> <span class="n">te_fractions</span><span class="p">)</span>

    <span class="n">nelements_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nelements</span><span class="p">)</span>
    <span class="n">neff_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="n">loss_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>

    <span class="n">mode</span><span class="o">.</span><span class="n">refine_mesh</span><span class="p">(</span><span class="n">mode_for_refinement</span><span class="o">=</span><span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">idx_mode</span><span class="p">])</span>

<span class="n">modes</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span>
    <span class="n">wavelength</span><span class="o">=</span><span class="mf">1.55</span><span class="p">,</span>
    <span class="n">num_modes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">metallic_boundaries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_guess</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
    <span class="n">return_modes</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Effective index - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">n_eff</span><span class="o">.</span><span class="n">real</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loss - mode </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_propagation_loss</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> dB/cm&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#------------------------------------------#&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modes</span><span class="p">)):</span>
    <span class="n">mode</span><span class="o">.</span><span class="n">plot_mode</span><span class="p">(</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Effective index - mode 0: 3.3101###################################] 100%
loss - mode 0: 59032.28 dB/cm
#------------------------------------------#
Effective index - mode 1: 3.2629
loss - mode 1: 49218.90 dB/cm
#------------------------------------------#
Effective index - mode 2: 3.2325
loss - mode 2: 4.38 dB/cm
#------------------------------------------#
Effective index - mode 3: 3.2324
loss - mode 3: 9.33 dB/cm
#------------------------------------------#
Effective index - mode 4: 3.1550
loss - mode 4: 60798.24 dB/cm
#------------------------------------------#
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_7_1.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_7_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_7_2.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_7_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_7_3.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_7_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_7_4.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_7_4.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_7_5.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_7_5.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mode</span><span class="o">.</span><span class="n">transfer_results_to_device</span><span class="p">(</span>
    <span class="n">TE_TM_idx</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\skfem\assembly\form\linear_form.py:44: ComplexWarning: Casting complex values to real discards the imaginary part
  data[ixs] = self._kernel(vbasis.basis[i], w, dx)
</pre></div></div>
</div>
</section>
<section id="Solving-the-PDD">
<h2>Solving the PDD<a class="headerlink" href="#Solving-the-PDD" title="Link to this heading">ÔÉÅ</a></h2>
<p>Now that we have our modes, we can calculate the charge transport quantities:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">+</span><span class="mf">0.01</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_n</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_wg2</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p1</span><span class="o">+</span><span class="n">eopm</span><span class="o">.</span><span class="n">h_p2</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">]])</span> <span class="c1">#simulation line</span>

<span class="n">charge</span><span class="o">=</span><span class="n">ChargeSimulatorSolcore</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_line</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
    <span class="n">bias_start_stop_step</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">30</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">plot_with_simulation_line</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="n">charge</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Charge transport will take place with:
p2
p1
wg2
wg1
n
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_10_1.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_10_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_10_2.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_10_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">solve_PDD</span><span class="p">(</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">smooth_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">charge</span><span class="o">.</span><span class="n">plot_results</span><span class="p">(</span>
    <span class="n">V_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>
                     <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                     <span class="nb">len</span><span class="p">(</span><span class="n">charge</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                     <span class="p">],</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Material &#34;n&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;wg2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p1&#34; does not have k-data defined. Returning &#34;zeros&#34;
Material &#34;p2&#34; does not have k-data defined. Returning &#34;zeros&#34;
Solving IV of the junctions...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\solcore\sesame_drift_diffusion\solve_pdd.py:193: UserWarning: All voltages are positive, but junction has been identified as n-p, so the  open-circuit voltage (Voc) of the junction will be negative.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Solving IV of the tunnel junctions...
Solving IV of the total solar cell...
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_11_3.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_11_3.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge</span><span class="o">.</span><span class="n">transfer_results_to_device</span><span class="p">(</span><span class="n">xmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Calculate-the-electro-optic-response">
<h2>Calculate the electro-optic response<a class="headerlink" href="#Calculate-the-electro-optic-response" title="Link to this heading">ÔÉÅ</a></h2>
<p>Now that we have the optical modes and the PDD data we can calculate the coupling constants</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EO</span><span class="o">=</span><span class="n">ElectroOpticalSimulator</span><span class="p">(</span>
    <span class="n">device</span><span class="o">=</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">simulation_window</span><span class="o">=</span><span class="n">shapely</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">EO</span><span class="o">.</span><span class="n">make_mesh</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">()</span>
<span class="n">EO</span><span class="o">.</span><span class="n">plot_polygons</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (um)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (um)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;y (um)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_14_1.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_14_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EO</span><span class="o">.</span><span class="n">get_epsilon_optical</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\numpy\numpy_func.py:322: RuntimeWarning: invalid value encountered in sqrt
  result_magnitude = func(*stripped_args, **stripped_kwargs)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1006: RuntimeWarning: divide by zero encountered in divide
  magnitude = magnitude_op(new_self._magnitude, other._magnitude)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1006: RuntimeWarning: invalid value encountered in divide
  magnitude = magnitude_op(new_self._magnitude, other._magnitude)
C:\Users\20230622\OneDrive - TU Eindhoven\PhD\Python packages\photonmod\src\imodulator\ElectroOpticalSimulator.py:367: UnitStrippedWarning: The unit of the quantity is stripped when downcasting to ndarray.
  epsilon_optical_all[EO_model_name][&#39;dperms&#39;][:, :, vertices_idxs, voltage_idx, perm_idx] = perm
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\numpy\numpy_func.py:322: RuntimeWarning: invalid value encountered in log
  result_magnitude = func(*stripped_args, **stripped_kwargs)
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1271: RuntimeWarning: invalid value encountered in power
  magnitude = new_self._magnitude**exponent
c:\Users\20230622\AppData\Local\anaconda3\envs\imodulator_venv\lib\site-packages\pint\facets\plain\quantity.py:1271: RuntimeWarning: invalid value encountered in sqrt
  magnitude = new_self._magnitude**exponent
</pre></div></div>
</div>
<p>The only effect in our system that can cause polarization conversion is the pockels effect, but only if we keep the <span class="math notranslate nohighlight">\(\Delta \epsilon\)</span> non-diagonal. Therefore, we shall study it as a function of angle as well.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Calculate the EO response for all voltages</span>
<span class="n">angle_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">kappa_te_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]),</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">kappa_te_tm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]),</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">kappa_tm_te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]),</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">kappa_tm_tm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]),</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">)):</span>
    <span class="c1">#Just a nice progress bar</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">M</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">prog</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="n">prog</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating EO response [</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">prog</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">])):</span>

        <span class="k">for</span> <span class="n">mode_a</span><span class="p">,</span> <span class="n">mode_b</span><span class="p">,</span> <span class="n">storage_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">,</span> <span class="s1">&#39;TE&#39;</span><span class="p">,</span> <span class="s1">&#39;TM&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">kappa_te_te</span><span class="p">,</span> <span class="n">kappa_te_tm</span><span class="p">,</span> <span class="n">kappa_tm_te</span><span class="p">,</span> <span class="n">kappa_tm_tm</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="n">EO</span><span class="o">.</span><span class="n">calculate_EO_response</span><span class="p">(</span>
                <span class="n">voltage_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">rot_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">rot_y</span><span class="o">=</span><span class="n">angle_values</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">rot_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">base_epsilon_voltage_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">optical_mode_a</span><span class="o">=</span><span class="n">mode_a</span><span class="p">,</span>
                <span class="n">optical_mode_b</span><span class="o">=</span><span class="n">mode_b</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">storage_list</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kappa</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Calculating EO response [##################################################] 100%
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">)))</span>

<span class="n">arrow_width</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
    <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">],</span>
    <span class="n">kappa</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
<span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angle_values</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kappa_te_tm</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">kappa_te_tm</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Angle = </span><span class="si">{</span><span class="n">angle</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="n">arrow_width</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
            <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Re($\kappa_{TE,TM}$)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Im($\kappa_{TE,TM}$)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="c1"># ax5.legend(bbox_to_anchor=(1.05, 1), loc=&#39;upper left&#39;)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">angle_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">angle_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
<span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">]:</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Angle (deg)&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&lt;&gt;:35: DeprecationWarning: invalid escape sequence &#39;\k&#39;
&lt;&gt;:36: DeprecationWarning: invalid escape sequence &#39;\k&#39;
&lt;&gt;:35: DeprecationWarning: invalid escape sequence &#39;\k&#39;
&lt;&gt;:36: DeprecationWarning: invalid escape sequence &#39;\k&#39;
C:\Users\20230622\AppData\Local\Temp\ipykernel_29600\779305644.py:35: DeprecationWarning: invalid escape sequence &#39;\k&#39;
  ax.set_xlabel(&#39;Re($\kappa_{TE,TM}$)&#39;)
C:\Users\20230622\AppData\Local\Temp\ipykernel_29600\779305644.py:36: DeprecationWarning: invalid escape sequence &#39;\k&#39;
  ax.set_ylabel(&#39;Im($\kappa_{TE,TM}$)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_18_1.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_18_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax5</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">)))</span>

<span class="n">arrow_width</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
    <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">],</span>
    <span class="n">kappa</span><span class="p">[</span><span class="s1">&#39;InGaAsPElectroOpticalModel&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
<span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angle_values</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kappa_tm_te</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">kappa_tm_te</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Angle = </span><span class="si">{</span><span class="n">angle</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="n">arrow_width</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
            <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Re($\kappa_{TM,TE}$)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Im($\kappa_{TM,TE}$)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="c1"># ax5.legend(bbox_to_anchor=(1.05, 1), loc=&#39;upper left&#39;)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">angle_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">angle_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
<span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">]:</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Angle (deg)&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&lt;&gt;:35: DeprecationWarning: invalid escape sequence &#39;\k&#39;
&lt;&gt;:36: DeprecationWarning: invalid escape sequence &#39;\k&#39;
&lt;&gt;:35: DeprecationWarning: invalid escape sequence &#39;\k&#39;
&lt;&gt;:36: DeprecationWarning: invalid escape sequence &#39;\k&#39;
C:\Users\20230622\AppData\Local\Temp\ipykernel_29600\3195157124.py:35: DeprecationWarning: invalid escape sequence &#39;\k&#39;
  ax.set_xlabel(&#39;Re($\kappa_{TM,TE}$)&#39;)
C:\Users\20230622\AppData\Local\Temp\ipykernel_29600\3195157124.py:36: DeprecationWarning: invalid escape sequence &#39;\k&#39;
  ax.set_ylabel(&#39;Im($\kappa_{TM,TE}$)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_19_1.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_19_1.png" />
</div>
</div>
<p>In the plot above, the color code is meant to represent the angle with respect to the y axis, and the direction of the arrows represents the increase in reverse bias voltage. We can clearly see that the most impactfull effect in the polarization conversion is by far the pockels effect. However, we see that the other effects also provide an effect. Because we are unsure if the theory holds for all effects, we will restrict ourselves to the pockels effect:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve_ivp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">f1</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">kaa</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kbb</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kba</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beta_TE</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta_TM</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the coupled mode equations for the TE and TM modes in the presence of coupling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">B</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dAdz</span><span class="o">=</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kaa</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kab</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">beta_TM</span><span class="o">-</span><span class="n">beta_TE</span><span class="p">)</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
    <span class="n">dBdz</span><span class="o">=</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kbb</span><span class="o">*</span><span class="n">B</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kba</span><span class="o">*</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">beta_TM</span><span class="o">-</span><span class="n">beta_TE</span><span class="p">)</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dAdz</span><span class="p">,</span> <span class="n">dBdz</span><span class="p">])</span>

<span class="n">z_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">20e-3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">A_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_space</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">B_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_space</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">)):</span>
    <span class="c1"># print(f&#39;Simulating propagation for angle {angle_values[j]*180/np.pi:.2f} degrees&#39;)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">#This will select only Pockels effect</span>
    <span class="n">voltage_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">k_aa</span> <span class="o">=</span> <span class="n">kappa_te_te</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">k_ab</span> <span class="o">=</span> <span class="n">kappa_te_tm</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">k_ba</span> <span class="o">=</span> <span class="n">kappa_tm_te</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">k_bb</span> <span class="o">=</span> <span class="n">kappa_tm_tm</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span>

    <span class="n">beta_TE</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">k</span>
    <span class="n">beta_TM</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">k</span>


    <span class="n">result</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">f1</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kaa</span><span class="o">=</span><span class="n">k_aa</span><span class="p">,</span> <span class="n">kbb</span><span class="o">=</span><span class="n">k_bb</span><span class="p">,</span> <span class="n">kba</span><span class="o">=</span><span class="n">k_ba</span><span class="p">,</span> <span class="n">kab</span><span class="o">=</span><span class="n">k_ab</span><span class="p">,</span> <span class="n">beta_TE</span><span class="o">=</span><span class="n">beta_TE</span><span class="p">,</span> <span class="n">beta_TM</span><span class="o">=</span><span class="n">beta_TM</span><span class="p">),</span>
        <span class="n">t_span</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_space</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">y0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">]),</span>
        <span class="n">t_eval</span><span class="o">=</span><span class="n">z_space</span><span class="p">,</span>
        <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">,</span>
        <span class="n">atol</span> <span class="o">=</span> <span class="mf">1e-12</span>
    <span class="p">)</span>

    <span class="n">A_values</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">B_values</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># plt.plot(z_space*1e3, np.abs(a)**2, label=&#39;TM&#39;)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># colors = cm.jet(np.linspace(0, 1, len(angle_values)))</span>
<span class="c1"># for j in range(len(angle_values)):</span>
<span class="c1">#     ax.plot(</span>
<span class="c1">#         z_space*1e3,</span>
<span class="c1">#         np.abs(A_values[j,:])**2,</span>
<span class="c1">#         label=f&#39;Angle = {angle_values[j]*180/np.pi:.1f}¬∞&#39;,</span>
<span class="c1">#         color = colors[j]</span>
<span class="c1">#     )</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A_values</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">z_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">z_space</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">angle_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">angle_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
    <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span>
<span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Normalized power in TE mode&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Propagation distance (mm)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Angle (degrees)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Voltage = </span><span class="si">{:.2f}</span><span class="s1"> V&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">][</span><span class="n">voltage_idx</span><span class="p">]))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\20230622\AppData\Local\Temp\ipykernel_29600\3798512384.py:70: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
  ax.legend(bbox_to_anchor=(1.05, 1), loc=&#39;upper left&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_21_1.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_21_1.png" />
</div>
</div>
<p>We said we would restrict to pockels, but we can include all the effects and see what happens.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve_ivp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">f1</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">kaa</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kbb</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kba</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beta_TE</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta_TM</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the coupled mode equations for the TE and TM modes in the presence of coupling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">B</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dAdz</span><span class="o">=</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kaa</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kab</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">beta_TM</span><span class="o">-</span><span class="n">beta_TE</span><span class="p">)</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
    <span class="n">dBdz</span><span class="o">=</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kbb</span><span class="o">*</span><span class="n">B</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kba</span><span class="o">*</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">beta_TM</span><span class="o">-</span><span class="n">beta_TE</span><span class="p">)</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dAdz</span><span class="p">,</span> <span class="n">dBdz</span><span class="p">])</span>

<span class="n">z_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">20e-3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">A_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_space</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
<span class="n">B_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_space</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angle_values</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulating propagation for angle </span><span class="si">{</span><span class="n">angle_values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> degrees&#39;</span><span class="p">)</span>
    <span class="n">voltage_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">k_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kappa_te_te</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">k_ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kappa_te_tm</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">k_ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kappa_tm_te</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">k_bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kappa_tm_tm</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">voltage_idx</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">beta_TE</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">k</span>
    <span class="n">beta_TM</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">k</span>


    <span class="n">result</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">f1</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kaa</span><span class="o">=</span><span class="n">k_aa</span><span class="p">,</span> <span class="n">kbb</span><span class="o">=</span><span class="n">k_bb</span><span class="p">,</span> <span class="n">kba</span><span class="o">=</span><span class="n">k_ba</span><span class="p">,</span> <span class="n">kab</span><span class="o">=</span><span class="n">k_ab</span><span class="p">,</span> <span class="n">beta_TE</span><span class="o">=</span><span class="n">beta_TE</span><span class="p">,</span> <span class="n">beta_TM</span><span class="o">=</span><span class="n">beta_TM</span><span class="p">),</span>
        <span class="n">t_span</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z_space</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">y0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="mi">0</span><span class="n">j</span><span class="p">]),</span>
        <span class="n">t_eval</span><span class="o">=</span><span class="n">z_space</span><span class="p">,</span>
        <span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">,</span>
        <span class="n">atol</span> <span class="o">=</span> <span class="mf">1e-12</span>
    <span class="p">)</span>

    <span class="n">A_values</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">B_values</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Simulating propagation for angle 0.00 degrees
Simulating propagation for angle 1.82 degrees
Simulating propagation for angle 3.64 degrees
Simulating propagation for angle 5.45 degrees
Simulating propagation for angle 7.27 degrees
Simulating propagation for angle 9.09 degrees
Simulating propagation for angle 10.91 degrees
Simulating propagation for angle 12.73 degrees
Simulating propagation for angle 14.55 degrees
Simulating propagation for angle 16.36 degrees
Simulating propagation for angle 18.18 degrees
Simulating propagation for angle 20.00 degrees
Simulating propagation for angle 21.82 degrees
Simulating propagation for angle 23.64 degrees
Simulating propagation for angle 25.45 degrees
Simulating propagation for angle 27.27 degrees
Simulating propagation for angle 29.09 degrees
Simulating propagation for angle 30.91 degrees
Simulating propagation for angle 32.73 degrees
Simulating propagation for angle 34.55 degrees
Simulating propagation for angle 36.36 degrees
Simulating propagation for angle 38.18 degrees
Simulating propagation for angle 40.00 degrees
Simulating propagation for angle 41.82 degrees
Simulating propagation for angle 43.64 degrees
Simulating propagation for angle 45.45 degrees
Simulating propagation for angle 47.27 degrees
Simulating propagation for angle 49.09 degrees
Simulating propagation for angle 50.91 degrees
Simulating propagation for angle 52.73 degrees
Simulating propagation for angle 54.55 degrees
Simulating propagation for angle 56.36 degrees
Simulating propagation for angle 58.18 degrees
Simulating propagation for angle 60.00 degrees
Simulating propagation for angle 61.82 degrees
Simulating propagation for angle 63.64 degrees
Simulating propagation for angle 65.45 degrees
Simulating propagation for angle 67.27 degrees
Simulating propagation for angle 69.09 degrees
Simulating propagation for angle 70.91 degrees
Simulating propagation for angle 72.73 degrees
Simulating propagation for angle 74.55 degrees
Simulating propagation for angle 76.36 degrees
Simulating propagation for angle 78.18 degrees
Simulating propagation for angle 80.00 degrees
Simulating propagation for angle 81.82 degrees
Simulating propagation for angle 83.64 degrees
Simulating propagation for angle 85.45 degrees
Simulating propagation for angle 87.27 degrees
Simulating propagation for angle 89.09 degrees
Simulating propagation for angle 90.91 degrees
Simulating propagation for angle 92.73 degrees
Simulating propagation for angle 94.55 degrees
Simulating propagation for angle 96.36 degrees
Simulating propagation for angle 98.18 degrees
Simulating propagation for angle 100.00 degrees
Simulating propagation for angle 101.82 degrees
Simulating propagation for angle 103.64 degrees
Simulating propagation for angle 105.45 degrees
Simulating propagation for angle 107.27 degrees
Simulating propagation for angle 109.09 degrees
Simulating propagation for angle 110.91 degrees
Simulating propagation for angle 112.73 degrees
Simulating propagation for angle 114.55 degrees
Simulating propagation for angle 116.36 degrees
Simulating propagation for angle 118.18 degrees
Simulating propagation for angle 120.00 degrees
Simulating propagation for angle 121.82 degrees
Simulating propagation for angle 123.64 degrees
Simulating propagation for angle 125.45 degrees
Simulating propagation for angle 127.27 degrees
Simulating propagation for angle 129.09 degrees
Simulating propagation for angle 130.91 degrees
Simulating propagation for angle 132.73 degrees
Simulating propagation for angle 134.55 degrees
Simulating propagation for angle 136.36 degrees
Simulating propagation for angle 138.18 degrees
Simulating propagation for angle 140.00 degrees
Simulating propagation for angle 141.82 degrees
Simulating propagation for angle 143.64 degrees
Simulating propagation for angle 145.45 degrees
Simulating propagation for angle 147.27 degrees
Simulating propagation for angle 149.09 degrees
Simulating propagation for angle 150.91 degrees
Simulating propagation for angle 152.73 degrees
Simulating propagation for angle 154.55 degrees
Simulating propagation for angle 156.36 degrees
Simulating propagation for angle 158.18 degrees
Simulating propagation for angle 160.00 degrees
Simulating propagation for angle 161.82 degrees
Simulating propagation for angle 163.64 degrees
Simulating propagation for angle 165.45 degrees
Simulating propagation for angle 167.27 degrees
Simulating propagation for angle 169.09 degrees
Simulating propagation for angle 170.91 degrees
Simulating propagation for angle 172.73 degrees
Simulating propagation for angle 174.55 degrees
Simulating propagation for angle 176.36 degrees
Simulating propagation for angle 178.18 degrees
Simulating propagation for angle 180.00 degrees
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plt.plot(z_space*1e3, np.abs(a)**2, label=&#39;TM&#39;)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>


<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A_values</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">z_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">z_space</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">angle_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">angle_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
    <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span>
<span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Normalized power in TE mode&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Propagation distance (mm)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Angle (degrees)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Voltage = </span><span class="si">{:.2f}</span><span class="s1"> V&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eopm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">charge</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">][</span><span class="n">voltage_idx</span><span class="p">]))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1">#Plot only the 0 angle case</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">z_space</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A_values</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Angle = </span><span class="si">{</span><span class="n">angle_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞&#39;</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">z_space</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">B_values</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Angle = </span><span class="si">{</span><span class="n">angle_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">¬∞&#39;</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\20230622\AppData\Local\Temp\ipykernel_29600\649306782.py:18: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
  ax.legend(bbox_to_anchor=(1.05, 1), loc=&#39;upper left&#39;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x277da5ce980&gt;]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_24_2.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_24_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/Tutorials_polarization_converter_polarization_converter_24_3.png" src="../../_images/Tutorials_polarization_converter_polarization_converter_24_3.png" />
</div>
</div>
<p>Is this a physical result? We don‚Äôt really know. Can you help?</p>
<p>Nonetheless, we can say something about the increase in performance when we consider the other effects. The reason for this increase in performance stems from the Kerr effect and the Z components of the optical fields which will allow the <span class="math notranslate nohighlight">\(k_{TE,TM}\)</span> to have a contribution of the form <span class="math notranslate nohighlight">\(E_{z,TE}^* E_{z,TM} \Delta \epsilon _{zz}\)</span>, and since <span class="math notranslate nohighlight">\(\Delta \epsilon_{zz}\)</span> is modulated efficiently by kerr effect, we have a better modulation.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../dc_electro_optical/dc_electro_optical.html" class="btn btn-neutral float-left" title="DC electro-optical modulation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Duarte Silva, Kaan S√ºnnet√ßioƒülu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>